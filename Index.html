<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>OliveTrack</title>
<meta name="application-name" content="OliveTrack">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="OliveTrack">
<meta name="theme-color" content="#052e16">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<!-- Apple touch icons (inline fallback) -->
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23052e16'/><text y='.9em' font-size='80' x='10'>ğŸ«’</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'DM Sans',sans-serif; transition:background 0.3s; }
input,select,button,textarea { font-family:inherit; }
.page { max-width:430px; margin:0 auto; min-height:100vh; position:relative; transition:background 0.3s,color 0.3s; }

/* LIGHT */
.light { background:#f8fafc; color:#1a1a2e; }
.light .card { background:white; box-shadow:0 2px 14px rgba(0,0,0,0.07); }
.light .header { background:#052e16; }
.light .header.admin { background:#1e1b4b; }
.light .section-bg { background:#f0fdf4; }
.light .section-bg.admin { background:#eef2ff; }
.light .input-border { border-color:#d1fae5; }
.light .input-bg { background:white; color:#1a1a2e; }
.light .muted { color:#6b7280; }
.light .divider { border-color:#f3f4f6; }
.light .nav-bg { background:white; border-color:#e5e7eb; }
.light .tab-inactive { background:#f0fdf4; color:#16a34a; }
.light .tab-inactive.admin { background:#eef2ff; color:#3730a3; }
.light .sub-bg { background:#f9fafb; }

/* DARK */
.dark { background:#0f172a; color:#e2e8f0; }
.dark .card { background:#1e293b; box-shadow:0 2px 14px rgba(0,0,0,0.4); }
.dark .header { background:#0a1f0f; }
.dark .header.admin { background:#0f0c29; }
.dark .section-bg { background:#1a2e1a; }
.dark .section-bg.admin { background:#12102e; }
.dark .input-border { border-color:#2d4a2d; }
.dark .input-bg { background:#1e293b; color:#e2e8f0; }
.dark .muted { color:#94a3b8; }
.dark .divider { border-color:#1e293b; }
.dark .nav-bg { background:#1e293b; border-color:#334155; }
.dark .tab-inactive { background:#1e3a1e; color:#4ade80; }
.dark .tab-inactive.admin { background:#1e1b4b; color:#818cf8; }
.dark .sub-bg { background:#273549; }

.scroll-area { overflow-y:auto; overflow-x:hidden; padding-bottom:90px; }
.header { position:sticky; top:0; z-index:50; padding:13px 20px; display:flex; justify-content:space-between; align-items:center; }
.bottom-nav { position:fixed; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:430px; display:flex; border-top:1px solid; z-index:100; }
.nav-btn { flex:1; padding:10px 4px 12px; border:none; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:2px; background:transparent; }
.card { border-radius:18px; padding:16px; margin-bottom:12px; cursor:pointer; transition:transform 0.15s,box-shadow 0.15s; }
.card:active { transform:scale(0.98); }
.tag { padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700; display:inline-block; }
.inf-bar-bg { border-radius:99px; height:10px; overflow:hidden; background:#e2e8f0; }
.dark .inf-bar-bg { background:#334155; }
.inf-bar-fill { height:100%; border-radius:99px; transition:width 0.6s cubic-bezier(.4,0,.2,1); }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.fade-in { animation:fadeIn 0.2s ease; }
.cal-day { border-radius:10px; padding:4px; cursor:pointer; text-align:center; transition:background 0.15s; min-height:52px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; }
.map-container { position:relative; overflow:hidden; cursor:crosshair; user-select:none; }
.map-tile { position:absolute; width:256px; height:256px; pointer-events:none; }
.btn-primary { width:100%; padding:14px; color:white; border:none; border-radius:14px; font-size:15px; font-weight:700; cursor:pointer; transition:filter 0.2s,transform 0.1s; margin-bottom:10px; }
.btn-primary:disabled { opacity:0.6; cursor:not-allowed; }
.spinner { display:inline-block; width:18px; height:18px; border:2px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation:spin 0.7s linear infinite; vertical-align:middle; }
@keyframes spin { to { transform:rotate(360deg); } }
.dot-online { width:8px; height:8px; border-radius:50%; background:#4ade80; display:inline-block; }
.dot-offline { width:8px; height:8px; border-radius:50%; background:#f97316; display:inline-block; }
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-thumb { background:#d1d5db; border-radius:4px; }
.dark ::-webkit-scrollbar-thumb { background:#475569; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useRef, useEffect, useCallback, useMemo } = React;
const { createPortal } = ReactDOM;

// â•â•â•â•â•â•â•â•â•â•â• SUPABASE â•â•â•â•â•â•â•â•â•â•â•
const SURL = "https://vbrszqirraacvfmlixow.supabase.co";
const SKEY = "sb_publishable_gX6gWIW8iB__hcLC_THdgQ_NFP9EPKQ";
const sb = supabase.createClient(SURL, SKEY, {
  auth: { persistSession: true, autoRefreshToken: true }
});

// â•â•â•â•â•â•â•â•â•â•â• OFFLINE CACHE â•â•â•â•â•â•â•â•â•â•â•
const Cache = {
  set(k,v){ try{ localStorage.setItem("ot_"+k, JSON.stringify(v)); }catch(e){} },
  get(k){ try{ const v=localStorage.getItem("ot_"+k); return v?JSON.parse(v):null; }catch(e){ return null; } },
  clear(){ Object.keys(localStorage).filter(k=>k.startsWith("ot_")).forEach(k=>localStorage.removeItem(k)); }
};

function useOnline(){
  const [online,setOnline]=useState(navigator.onLine);
  useEffect(()=>{
    const on=()=>setOnline(true), off=()=>setOnline(false);
    window.addEventListener("online",on); window.addEventListener("offline",off);
    return()=>{ window.removeEventListener("online",on); window.removeEventListener("offline",off); };
  },[]);
  return online;
}

function genCode(){ return "OT-"+new Date().getFullYear()+"-"+Math.random().toString(36).substr(2,4).toUpperCase(); }
function fmtDate(d){ return d?String(d).slice(0,10):""; }

// â•â•â•â•â•â•â•â•â•â•â• LEGACY COMPAT â€” dati demo vuoti (vengono da Supabase) â•â•â•â•â•â•â•â•â•â•â•
const USERS = [];
const OLIVETI0 = [], TRAP0 = [], RIL0 = [], STER0 = [], TRAT0 = [];

let SA=30, SP=60;

// â•â•â•â•â•â•â•â•â•â•â• HELPERS â•â•â•â•â•â•â•â•â•â•â•
function rischio(m){
  if(m>=SP) return {l:"PERICOLO",c:"#dc2626",bg:"rgba(220,38,38,0.12)",border:"#dc2626"};
  if(m>=SA) return {l:"ALLERTA",c:"#d97706",bg:"rgba(217,119,6,0.12)",border:"#d97706"};
  return {l:"OK",c:"#16a34a",bg:"rgba(22,163,74,0.12)",border:"#16a34a"};
}
function calcInf(s){
  if(!s||!s.camp) return null;
  return {
    att:Math.min(((s.uova+s.l1+s.l2)/s.camp)*100,100),
    tot:Math.min(((s.uova+s.l1+s.l2+s.l3+s.pupe+s.fori)/s.camp)*100,100)
  };
}
function lastOf(arr,k,v){ return [...arr].filter(x=>x[k]===v).sort((a,b)=>b.data.localeCompare(a.data))[0]||null; }
function cInf(v){ return v>10?"#dc2626":v>5?"#d97706":"#16a34a"; }
function dayName(d){ return ["Dom","Lun","Mar","Mer","Gio","Ven","Sab"][d]; }
function monthName(m){ return ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"][m]; }

// â•â•â•â•â•â•â•â•â•â•â• THEME CONTEXT â•â•â•â•â•â•â•â•â•â•â•
const ThemeCtx = React.createContext({dark:false,toggle:()=>{}});

// â•â•â•â•â•â•â•â•â•â•â• INF BAR â•â•â•â•â•â•â•â•â•â•â•
function InfBar({label,value,color}){
  return(
    <div style={{marginBottom:10}}>
      <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
        <span style={{fontSize:12,fontWeight:600}} className="muted">{label}</span>
        <span style={{fontSize:14,fontWeight:700,color}}>{value.toFixed(1)}%</span>
      </div>
      <div className="inf-bar-bg">
        <div className="inf-bar-fill" style={{width:`${Math.min(value,100)}%`,background:color}}/>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â• DUAL CHART (mosche + infestazione) â•â•â•â•â•â•â•â•â•â•â•
function DualChart({oId,rils,sters,showSeason,dark}){
  const [mode,setMode]=useState("mosche");
  const W=300,H=100,P=20,LEGEND_H=22;

  // MOSCHE chart
  function MoscheChart({data,extra}){
    if(!data||data.length<2) return(
      <div style={{textAlign:"center",padding:"24px 0",color:dark?"#64748b":"#9ca3af",fontSize:13}}>
        ğŸ“Š Dati insufficienti â€” servono almeno 2 rilevamenti
      </div>
    );
    const all=[...data,...(extra||[])];
    const max=Math.max(...all.map(d=>d.mosche),SP+10);
    const xs=d=>d.map((_,i)=>P+(i/(d.length-1))*(W-P*2));
    const ys=d=>d.map(x=>H-P-((x.mosche/max)*(H-P*2)));
    const path=(d,x,y)=>x.map((v,i)=>`${i===0?"M":"L"} ${v} ${y[i]}`).join(" ");
    const area=(d,x,y)=>`${path(d,x,y)} L ${x[x.length-1]} ${H-P} L ${x[0]} ${H-P} Z`;
    const s1y=H-P-((SA/max)*(H-P*2));
    const s2y=H-P-((SP/max)*(H-P*2));
    const x1=xs(data), y1=ys(data);
    const x2=extra?xs(extra):null, y2=extra?ys(extra):null;
    const gId="gm"+oId;
    const totalH=H+LEGEND_H+(extra?LEGEND_H:0);
    return(
      <svg width="100%" viewBox={`0 0 ${W} ${totalH}`} style={{overflow:"visible"}}>
        <defs>
          <linearGradient id={gId} x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stopColor="#16a34a" stopOpacity="0.3"/>
            <stop offset="100%" stopColor="#16a34a" stopOpacity="0"/>
          </linearGradient>
        </defs>
        <line x1={P} y1={s2y} x2={W-P} y2={s2y} stroke="#dc2626" strokeWidth="1" strokeDasharray="4,3" opacity="0.6"/>
        <line x1={P} y1={s1y} x2={W-P} y2={s1y} stroke="#d97706" strokeWidth="1" strokeDasharray="4,3" opacity="0.6"/>
        <text x={W-P+2} y={s2y+3} fontSize="8" fill="#dc2626">{SP}</text>
        <text x={W-P+2} y={s1y+3} fontSize="8" fill="#d97706">{SA}</text>
        {extra&&x2&&<path d={path(extra,x2,y2)} fill="none" stroke="#a78bfa" strokeWidth="1.5" strokeDasharray="5,3" strokeLinecap="round"/>}
        {extra&&x2&&x2.map((x,i)=><circle key={i} cx={x} cy={y2[i]} r="2.5" fill="#a78bfa" stroke={dark?"#1e293b":"white"} strokeWidth="1"/>)}
        <path d={area(data,x1,y1)} fill={`url(#${gId})`}/>
        <path d={path(data,x1,y1)} fill="none" stroke="#16a34a" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
        {x1.map((x,i)=><circle key={i} cx={x} cy={y1[i]} r="3.5" fill={data[i].mosche>=SP?"#dc2626":data[i].mosche>=SA?"#d97706":"#16a34a"} stroke={dark?"#1e293b":"white"} strokeWidth="1.5"/>)}
        {/* date labels */}
        {data.map((d,i)=><text key={i} x={x1[i]} y={H+10} textAnchor="middle" fontSize="8" fill={dark?"#64748b":"#9ca3af"}>{d.data.slice(5)}</text>)}
        {/* legend below dates */}
        {extra&&<g transform={`translate(0,${H+LEGEND_H})`}>
          <circle cx={P+6} cy={8} r="4" fill="#16a34a"/>
          <text x={P+14} y={12} fontSize="8" fill={dark?"#94a3b8":"#6b7280"}>2024</text>
          <line x1={P+40} y1={8} x2={P+52} y2={8} stroke="#a78bfa" strokeWidth="2" strokeDasharray="4,2"/>
          <text x={P+56} y={12} fontSize="8" fill={dark?"#94a3b8":"#6b7280"}>2023</text>
        </g>}
      </svg>
    );
  }

  // INFESTAZIONE chart
  function InfChart({data}){
    if(!data||data.length<2) return(
      <div style={{textAlign:"center",padding:"24px 0",color:dark?"#64748b":"#9ca3af",fontSize:13}}>
        ğŸ”¬ Dati insufficienti â€” servono almeno 2 campionamenti
      </div>
    );
    const max=Math.max(...data.map(d=>Math.max(d.att,d.tot)),30);
    const xs=data.map((_,i)=>P+(i/(data.length-1))*(W-P*2));
    const ya=data.map(d=>H-P-((d.att/max)*(H-P*2)));
    const yt=data.map(d=>H-P-((d.tot/max)*(H-P*2)));
    const pa=xs.map((x,i)=>`${i===0?"M":"L"} ${x} ${ya[i]}`).join(" ");
    const pt=xs.map((x,i)=>`${i===0?"M":"L"} ${x} ${yt[i]}`).join(" ");
    const l10=H-P-((10/max)*(H-P*2));
    const l20=H-P-((20/max)*(H-P*2));
    const totalH=H+LEGEND_H+LEGEND_H;
    return(
      <svg width="100%" viewBox={`0 0 ${W} ${totalH}`} style={{overflow:"visible"}}>
        <line x1={P} y1={l10} x2={W-P} y2={l10} stroke="#d97706" strokeWidth="1" strokeDasharray="3,3" opacity="0.5"/>
        <line x1={P} y1={l20} x2={W-P} y2={l20} stroke="#dc2626" strokeWidth="1" strokeDasharray="3,3" opacity="0.5"/>
        <text x={W-P+2} y={l10+3} fontSize="8" fill="#d97706">10%</text>
        <text x={W-P+2} y={l20+3} fontSize="8" fill="#dc2626">20%</text>
        <path d={pt} fill="none" stroke="#7c3aed" strokeWidth="1.5" strokeDasharray="5,3" strokeLinecap="round"/>
        <path d={pa} fill="none" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
        {xs.map((x,i)=><circle key={i+"a"} cx={x} cy={ya[i]} r="3.5" fill={cInf(data[i].att)} stroke={dark?"#1e293b":"white"} strokeWidth="1.5"/>)}
        {xs.map((x,i)=><circle key={i+"t"} cx={x} cy={yt[i]} r="2.5" fill="#7c3aed" stroke={dark?"#1e293b":"white"} strokeWidth="1"/>)}
        {data.map((d,i)=><text key={i} x={xs[i]} y={H+10} textAnchor="middle" fontSize="8" fill={dark?"#64748b":"#9ca3af"}>{d.data.slice(5)}</text>)}
        <g transform={`translate(0,${H+LEGEND_H})`}>
          <circle cx={P+6} cy={8} r="4" fill="#d97706"/>
          <text x={P+14} y={12} fontSize="8" fill={dark?"#94a3b8":"#6b7280"}>Attiva</text>
          <line x1={P+44} y1={8} x2={P+56} y2={8} stroke="#7c3aed" strokeWidth="2" strokeDasharray="4,2"/>
          <text x={P+60} y={12} fontSize="8" fill={dark?"#94a3b8":"#6b7280"}>Totale</text>
        </g>
      </svg>
    );
  }

  const rilYear=y=>[...rils].filter(r=>r.oId===oId&&r.stagione===y).sort((a,b)=>a.data.localeCompare(b.data));
  const cur=rilYear(2024), prev=rilYear(2023);
  const sterData=[...sters].filter(s=>s.oId===oId).sort((a,b)=>a.data.localeCompare(b.data)).map(s=>({...calcInf(s),data:s.data}));

  // always show all 3 tab buttons
  const chartTabs=[
    {id:"mosche",label:"ğŸª¤ Mosche"},
    {id:"inf",label:"ğŸ”¬ Infestazione"},
    {id:"season",label:"ğŸ“Š Stagioni"},
  ];

  return(
    <div>
      <div style={{display:"flex",gap:6,marginBottom:14,flexWrap:"wrap"}}>
        {chartTabs.map(t=>(
          <button key={t.id} onClick={()=>setMode(t.id)}
            style={{padding:"6px 12px",borderRadius:8,border:"none",cursor:"pointer",fontSize:12,fontWeight:600,
              background:mode===t.id?"#16a34a":(dark?"#1e3a1e":"#f0fdf4"),
              color:mode===t.id?"white":(dark?"#4ade80":"#16a34a")}}>
            {t.label}
          </button>
        ))}
      </div>
      {mode==="mosche"&&<MoscheChart data={cur.length?cur:prev}/>}
      {mode==="season"&&<MoscheChart data={cur.length?cur:prev} extra={prev.length&&cur.length?prev:null}/>}
      {mode==="inf"&&<InfChart data={sterData}/>}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â• CALENDARIO â•â•â•â•â•â•â•â•â•â•â•
function Calendario({rils,sters,trats,oliveti,dark,role}){
  const [date,setDate]=useState(new Date(2024,7,1));
  const year=date.getFullYear(), month=date.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();

  const prefix=`${year}-${String(month+1).padStart(2,"0")}`;
  const rilMap={}, sterMap={}, tratMap={};
  rils.forEach(r=>{ if(r.data.startsWith(prefix)){ const d=parseInt(r.data.slice(8)); if(!rilMap[d])rilMap[d]=[];rilMap[d].push(r); }});
  sters.forEach(s=>{ if(s.data.startsWith(prefix)){ const d=parseInt(s.data.slice(8)); if(!sterMap[d])sterMap[d]=[];sterMap[d].push(s); }});
  trats.forEach(t=>{ if(t.data.startsWith(prefix)){ const d=parseInt(t.data.slice(8)); if(!tratMap[d])tratMap[d]=[];tratMap[d].push(t); }});

  const cells=[];
  for(let i=0;i<(firstDay===0?6:firstDay-1);i++) cells.push(null);
  for(let d=1;d<=daysInMonth;d++) cells.push(d);

  const todayBg = dark?"#1e3a1e":"#d1fae5";
  const cardBg = dark?"#1e293b":"white";
  const mutedC = dark?"#94a3b8":"#6b7280";

  function getBg(d){
    const rs=rilMap[d]||[];
    if(rs.some(r=>r.mosche>=SP)) return "rgba(220,38,38,0.15)";
    if(rs.some(r=>r.mosche>=SA)) return "rgba(217,119,6,0.12)";
    if(rs.length||sterMap[d]||tratMap[d]) return "rgba(22,163,74,0.1)";
    return "transparent";
  }

  return(
    <div className="fade-in">
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16,padding:"0 2px"}}>
        <button onClick={()=>setDate(new Date(year,month-1,1))} style={{background:"none",border:"none",fontSize:20,cursor:"pointer",color:dark?"#94a3b8":"#6b7280"}}>â€¹</button>
        <h3 style={{fontFamily:"Lora,serif",fontSize:18}}>{monthName(month)} {year}</h3>
        <button onClick={()=>setDate(new Date(year,month+1,1))} style={{background:"none",border:"none",fontSize:20,cursor:"pointer",color:dark?"#94a3b8":"#6b7280"}}>â€º</button>
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:4,marginBottom:8}}>
        {["L","M","M","G","V","S","D"].map((d,i)=><div key={i} style={{textAlign:"center",fontSize:11,fontWeight:700,color:mutedC,padding:"4px 0"}}>{d}</div>)}
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:4}}>
        {cells.map((d,i)=>(
          <div key={i} className="cal-day" style={{background:d?getBg(d):"transparent",opacity:d?1:0.3}}>
            {d&&<span style={{fontSize:13,fontWeight:600}}>{d}</span>}
            {d&&<div style={{display:"flex",gap:2,flexWrap:"wrap",justifyContent:"center"}}>
              {rilMap[d]?.slice(0,1).map(r=><span key={r.id} style={{fontSize:8,background:rischio(r.mosche).c,color:"white",borderRadius:4,padding:"0 3px"}}>{r.mosche}ğŸª¤</span>)}
              {sterMap[d]?.length>0&&<span style={{fontSize:8,background:"#7c3aed",color:"white",borderRadius:4,padding:"0 3px"}}>ğŸ”¬</span>}
              {tratMap[d]?.length>0&&<span style={{fontSize:8,background:"#16a34a",color:"white",borderRadius:4,padding:"0 3px"}}>ğŸ’Š</span>}
            </div>}
          </div>
        ))}
      </div>
      <div style={{marginTop:14,display:"flex",gap:8,flexWrap:"wrap"}}>
        {[["ğŸª¤ Rilevamento trappola","#16a34a"],["ğŸ”¬ Stereoscopio","#7c3aed"],["ğŸ’Š Trattamento","#059669"],["âš ï¸ Allerta",rischio(SA).c],["ğŸš¨ Pericolo",rischio(SP).c]].map(([l,c])=>(
          <div key={l} style={{display:"flex",alignItems:"center",gap:4,fontSize:11,color:mutedC}}>
            <div style={{width:8,height:8,borderRadius:2,background:c}}/>{l}
          </div>
        ))}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â• GESTIONE TRAPPOLE (admin only) â•â•â•â•â•â•â•â•â•â•â•
function GestioneTrappole({trappole,setTrappole,oId,oliveto,dark,onBack,adminId}){
  const [showAdd,setShowAdd]=useState(false);
  const [f,setF]=useState({nome:"",tipo:"Cromotropica"});
  const [saving,setSaving]=useState(false);
  const myT=trappole.filter(t=>(t.oliveto_id||t.oId)===oId);
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const cardBg=dark?"#1e293b":"white";
  const mutedC=dark?"#94a3b8":"#6b7280";
  const tipoIcon={"Cromotropica":"ğŸŸ¡","A feromoni":"ğŸŸ£","Attrattivo alimentare":"ğŸŸ¢","Multilure":"ğŸ”µ"};

  async function save(){
    if(!f.nome){alert("Inserisci nome trappola");return;}
    setSaving(true);
    const{data}=await sb.from("trappole").insert({nome:f.nome,tipo:f.tipo,oliveto_id:oId,admin_id:adminId,attiva:true}).select().single();
    if(data) setTrappole(p=>[...p,{...data,oId:data.oliveto_id}]);
    setF({nome:"",tipo:"Cromotropica"});setShowAdd(false);setSaving(false);
  }
  async function toggle(id,cur){
    await sb.from("trappole").update({attiva:!cur}).eq("id",id);
    setTrappole(p=>p.map(t=>t.id===id?{...t,attiva:!cur}:t));
  }
  async function remove(id){
    if(!confirm("Rimuovere questa trappola?")) return;
    await sb.from("trappole").delete().eq("id",id);
    setTrappole(p=>p.filter(t=>t.id!==id));
  }

  const selStyle={width:"100%",padding:"9px 12px",border:`1.5px solid ${dark?"#2d4a2d":"#d1fae5"}`,borderRadius:10,fontSize:14,outline:"none",background:dark?"#273549":"white",color:dark?"#e2e8f0":"#1a1a2e"};

  return(
    <div>
      <div style={{background:dark?"#0a1f0f":"linear-gradient(135deg,#052e16,#166534)",padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸª¤ Gestione Trappole</h2>
        <p style={{color:"#86efac",margin:"4px 0 0",fontSize:13}}>{oliveto?.nome}</p>
      </div>
      <div style={{padding:16}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
          <h3 style={{fontFamily:"Lora,serif",fontSize:16}}>{myT.length} trappol{myT.length===1?"a":"e"}</h3>
          <span style={{fontSize:12,color:mutedC}}>{myT.filter(t=>t.attiva).length} attive</span>
        </div>
        {myT.map(t=>(
          <div key={t.id} style={{background:cardBg,borderRadius:14,padding:14,marginBottom:10,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)",opacity:t.attiva?1:0.55}}>
            <div style={{display:"flex",alignItems:"center",gap:12}}>
              <div style={{fontSize:26}}>{tipoIcon[t.tipo]||"ğŸ”µ"}</div>
              <div style={{flex:1}}>
                <div style={{fontWeight:700,fontSize:15}}>{t.nome}</div>
                <div style={{fontSize:12,color:mutedC}}>{t.tipo}</div>
              </div>
              <div style={{display:"flex",gap:8,alignItems:"center"}}>
                <div onClick={()=>toggle(t.id,t.attiva)} style={{width:42,height:24,borderRadius:12,background:t.attiva?"#16a34a":"#94a3b8",cursor:"pointer",position:"relative",transition:"background 0.2s"}}>
                  <div style={{position:"absolute",top:2,left:t.attiva?20:2,width:20,height:20,borderRadius:10,background:"white",transition:"left 0.2s",boxShadow:"0 1px 4px rgba(0,0,0,0.2)"}}/>
                </div>
                <button onClick={()=>remove(t.id)} style={{background:"none",border:"none",fontSize:16,cursor:"pointer",color:"#dc2626",padding:4}}>ğŸ—‘</button>
              </div>
            </div>
          </div>
        ))}
        {showAdd?(
          <div style={{background:cardBg,borderRadius:14,padding:16,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
            <h4 style={{margin:"0 0 14px",fontFamily:"Lora,serif"}}>Nuova trappola</h4>
            <div style={{marginBottom:12}}>
              <label style={{display:"block",fontSize:13,fontWeight:600,color:mutedC,marginBottom:5}}>Nome trappola *</label>
              <input value={f.nome} onChange={e=>set("nome",e.target.value)} placeholder="Es. Trappola Nord"
                style={{...selStyle,border:`1.5px solid ${dark?"#2d4a2d":"#d1fae5"}`}}/>
            </div>
            <div style={{marginBottom:14}}>
              <label style={{display:"block",fontSize:13,fontWeight:600,color:mutedC,marginBottom:5}}>Tipo trappola</label>
              <select value={f.tipo} onChange={e=>set("tipo",e.target.value)} style={selStyle}>
                {["Cromotropica","A feromoni","Attrattivo alimentare","Multilure"].map(o=><option key={o} value={o}>{tipoIcon[o]} {o}</option>)}
              </select>
            </div>
            <div style={{display:"flex",gap:10}}>
              <button onClick={save} disabled={saving} className="btn-primary" style={{background:"#16a34a",marginBottom:0}}>{saving?<span className="spinner"/>:"ğŸ’¾ Salva"}</button>
              <button onClick={()=>setShowAdd(false)} className="btn-primary" style={{background:dark?"#334155":"#f3f4f6",color:dark?"#e2e8f0":"#374151",marginBottom:0}}>Annulla</button>
            </div>
          </div>
        ):(
          <button onClick={()=>setShowAdd(true)} style={{width:"100%",padding:14,background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"2px dashed #86efac",borderRadius:14,fontSize:15,fontWeight:600,cursor:"pointer"}}>
            + Aggiungi trappola
          </button>
        )}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â• MAP PICKER â•â•â•â•â•â•â•â•â•â•â•
function MapPicker({initLat,initLng,onConfirm,onClose,dark}){
  const [lat,setLat]=useState(initLat||43.7);
  const [lng,setLng]=useState(initLng||8.0);
  const [search, setSearch] = useState("");
  const [off,setOff]=useState({x:0,y:0});
  const [dragging,setDragging]=useState(false);
  const mapRef=useRef(null);
  const drag=useRef(null);
  const ZOOM=18, TILE=256, MW=360, MH=280;

  function toTile(la,lo){
    const n=Math.pow(2,ZOOM),x=((lo+180)/360)*n;
    const lr=(la*Math.PI)/180,y=((1-Math.log(Math.tan(lr)+1/Math.cos(lr))/Math.PI)/2)*n;
    return{x,y};
  }

  async function doSearch() {
    if(!search) return;
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(search)}`);
      const data = await res.json();
      if(data && data.length > 0) {
        setLat(parseFloat(data[0].lat));
        setLng(parseFloat(data[0].lon));
        setOff({x:0,y:0});
      }
    } catch(e) { console.error("Errore ricerca"); }
  }

  const center=toTile(lat,lng);
  const nx=Math.ceil(MW/TILE)+3, ny=Math.ceil(MH/TILE)+3;
  const stx=Math.floor(center.x)-Math.floor(nx/2);
  const sty=Math.floor(center.y)-Math.floor(ny/2);
  
  const tiles=[];
  for(let dy=0;dy<ny;dy++) for(let dx=0;dx<nx;dx++){
    const tx=stx+dx, ty=sty+dy;
    const px=(dx-Math.floor(nx/2))*TILE+MW/2+(Math.floor(center.x)-center.x)*TILE+off.x;
    const py=(dy-Math.floor(ny/2))*TILE+MH/2+(Math.floor(center.y)-center.y)*TILE+off.y;
    tiles.push({sx:tx, ty:ty, px, py});
  }

  function pxToLL(px,py){
    const rx=(px-MW/2-off.x)/TILE+center.x, ry=(py-MH/2-off.y)/TILE+center.y, n=Math.pow(2,ZOOM);
    return{
      lat:parseFloat(((Math.atan(Math.sinh(Math.PI*(1-(2*ry)/n)))*180)/Math.PI).toFixed(6)),
      lng:parseFloat(((rx/n)*360-180).toFixed(6))
    };
  }

  function onMD(e){drag.current={x:e.clientX,y:e.clientY,ox:off.x,oy:off.y};}
  function onMM(e){if(!drag.current)return;const dx=e.clientX-drag.current.x, dy=e.clientY-drag.current.y;if(Math.abs(dx)>3||Math.abs(dy)>3)setDragging(true);setOff({x:drag.current.ox+dx,y:drag.current.oy+dy});}
  function onMU(){if(dragging){const{lat:nl,lng:nlo}=pxToLL(MW/2-off.x,MH/2-off.y);setLat(nl);setLng(nlo);setOff({x:0,y:0});}setTimeout(()=>setDragging(false),10);drag.current=null;}

  return(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.85)",zIndex:2000,display:"flex",alignItems:"center",justifyContent:"center",padding:10}}>
      <div style={{background:dark?"#1e293b":"white",borderRadius:20,overflow:"hidden",width:"100%",maxWidth:400}}>
        <div style={{background:"#052e16",padding:15,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
           <span style={{color:"white",fontWeight:700}}>ğŸ“ Mappa Satellitare</span>
           <button onClick={onClose} style={{background:"none",border:"none",color:"white",fontSize:20}}>Ã—</button>
        </div>
        
        <div style={{padding:10, display:"flex", gap:5}}>
          <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Cerca cittÃ  o via..." 
                 style={{flex:1, padding:10, borderRadius:8, border:"1px solid #ccc", fontSize:14}}
                 onKeyDown={e=>e.key==="Enter"&&doSearch()}/>
          <button onClick={doSearch} style={{padding:"0 15px", background:"#16a34a", color:"white", border:"none", borderRadius:8}}>ğŸ”</button>
        </div>

        <div ref={mapRef} style={{position:"relative",width:"100%",height:MH,overflow:"hidden",background:"#000",cursor:"crosshair"}}
             onMouseDown={onMD} onMouseMove={onMM} onMouseUp={onMU}>
          {tiles.map((t,i)=>(
            <img key={i} 
              src={`https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${ZOOM}/${t.ty}/${t.sx}`}
              style={{position:"absolute",width:TILE,height:TILE,left:t.px,top:t.py,pointerEvents:"none"}}
              alt="" draggable={false} />
          ))}
          <div style={{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%,-100%)",zIndex:10,fontSize:35,filter:"drop-shadow(0 2px 4px black)"}}>ğŸ“</div>
        </div>

        <div style={{padding:15}}>
          <button onClick={()=>onConfirm(lat,lng)} className="btn-primary" style={{background:"#16a34a",margin:0}}>Conferma Posizione</button>
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â• AUTH SCREENS â•â•â•â•â•â•â•â•â•â•â•
function Login({dark}){
  const [screen,setScreen]=useState("login"); // login | register | forgot
  const [email,setEmail]=useState(""),[ pw,setPw]=useState(""),[ err,setErr]=useState(""),[ load,setLoad]=useState(false);
  // Register state
  const [step,setStep]=useState(1),[code,setCode]=useState(""),[codeData,setCodeData]=useState(null);
  const [name,setName]=useState(""),[ pw2,setPw2]=useState(""),[done,setDone]=useState(false);
  // Forgot state
  const [sent,setSent]=useState(false);

  const cardBg=dark?"#1e293b":"white";
  const inp={width:"100%",padding:"11px 14px",border:`1.5px solid ${dark?"#2d4a2d":"#d1fae5"}`,borderRadius:10,fontSize:15,marginBottom:14,outline:"none",boxSizing:"border-box",background:dark?"#273549":"white",color:dark?"#e2e8f0":"#1a1a2e"};
  const bg=dark?"linear-gradient(160deg,#020d05,#0a1f0a)":"linear-gradient(160deg,#052e16,#14532d)";

  async function doLogin(){
    setLoad(true);setErr("");
    const{error}=await sb.auth.signInWithPassword({email,password:pw});
    if(error) setErr("Email o password errata");
    setLoad(false);
  }
  async function checkCode(){
    setLoad(true);setErr("");
    const{data,error}=await sb.from("invite_codes").select("*").eq("code",code.trim().toUpperCase()).eq("used",false).gt("expires_at",new Date().toISOString()).maybeSingle();
    if(!data){setErr("Codice non valido o scaduto. Contatta il tuo tecnico.");setLoad(false);return;}
    setCodeData(data);setStep(2);setLoad(false);
  }
  async function doRegister(){
    if(!name){setErr("Inserisci il tuo nome");return;}
    if(pw.length<6){setErr("Password minimo 6 caratteri");return;}
    if(pw!==pw2){setErr("Le password non coincidono");return;}
    setLoad(true);setErr("");
    const{data:authData,error}=await sb.auth.signUp({email,password:pw,options:{data:{name,role:"client",admin_id:codeData.admin_id}}});
    if(error){setErr(error.message);setLoad(false);return;}
    await sb.from("invite_codes").update({used:true,used_by:authData.user?.id,used_at:new Date().toISOString()}).eq("id",codeData.id);
    setDone(true);setLoad(false);
  }
  async function doForgot(){
    setLoad(true);
    await sb.auth.resetPasswordForEmail(email,{redirectTo:window.location.href});
    setSent(true);setLoad(false);
  }

  const Hero=()=><div style={{marginBottom:28,textAlign:"center"}}>
    <div style={{fontSize:60,marginBottom:8}}>ğŸ«’</div>
    <h1 style={{color:"white",fontFamily:"Lora,serif",fontSize:30,fontWeight:700}}>OliveTrack</h1>
    <p style={{color:"#86efac",margin:"6px 0 0",fontSize:14,fontStyle:"italic",fontFamily:"Lora,serif"}}>Monitoraggio Mosca delle Olive</p>
  </div>;

  if(screen==="login") return(<div style={{minHeight:"100vh",background:bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:24}}>
    <Hero/>
    <div style={{background:cardBg,borderRadius:24,padding:28,width:"100%",maxWidth:340,boxShadow:"0 30px 80px rgba(0,0,0,0.5)"}}>
      <h2 style={{margin:"0 0 20px",fontSize:20,color:dark?"#e2e8f0":"#14532d",fontFamily:"Lora,serif"}}>Accedi</h2>
      <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Email</label>
      <input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="tuo@email.it" style={inp}/>
      <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Password</label>
      <input type="password" value={pw} onChange={e=>setPw(e.target.value)} onKeyDown={e=>e.key==="Enter"&&doLogin()} style={inp}/>
      {err&&<p style={{color:"#dc2626",fontSize:13,margin:"0 0 10px"}}>{err}</p>}
      <button onClick={doLogin} disabled={load} className="btn-primary" style={{background:"#16a34a",fontFamily:"Lora,serif",fontSize:16,marginBottom:8}}>
        {load?<span className="spinner"/>:"Entra â†’"}
      </button>
      <div style={{display:"flex",justifyContent:"space-between"}}>
        <button onClick={()=>{setScreen("register");setStep(1);setErr("");}} style={{background:"none",border:"none",color:dark?"#4ade80":"#16a34a",cursor:"pointer",fontSize:13,fontWeight:600}}>Ho un codice invito</button>
        <button onClick={()=>{setScreen("forgot");setErr("");setSent(false);}} style={{background:"none",border:"none",color:dark?"#94a3b8":"#6b7280",cursor:"pointer",fontSize:12}}>Password dimenticata?</button>
      </div>
    </div>
  </div>);

  if(screen==="register") return(<div style={{minHeight:"100vh",background:bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:24}}>
    {done?<div style={{background:cardBg,borderRadius:24,padding:28,width:"100%",maxWidth:340,textAlign:"center"}}>
      <div style={{fontSize:60,marginBottom:12}}>âœ…</div>
      <h2 style={{fontFamily:"Lora,serif",color:dark?"#e2e8f0":"#052e16",marginBottom:8}}>Registrazione completata!</h2>
      <p style={{color:dark?"#94a3b8":"#6b7280",fontSize:14,marginBottom:20}}>Controlla la tua email per confermare l'account, poi accedi.</p>
      <button onClick={()=>setScreen("login")} className="btn-primary" style={{background:"#16a34a",marginBottom:0}}>Vai al login â†’</button>
    </div>:<div style={{background:cardBg,borderRadius:24,padding:28,width:"100%",maxWidth:340,boxShadow:"0 30px 80px rgba(0,0,0,0.5)"}}>
      <button onClick={()=>setScreen("login")} style={{background:"none",border:"none",color:dark?"#94a3b8":"#6b7280",cursor:"pointer",marginBottom:16,fontSize:13}}>â† Torna al login</button>
      <div style={{fontSize:36,textAlign:"center",marginBottom:8}}>ğŸ«’</div>
      {step===1?<>
        <h2 style={{margin:"0 0 6px",fontSize:18,color:dark?"#e2e8f0":"#14532d",fontFamily:"Lora,serif",textAlign:"center"}}>Crea account</h2>
        <p style={{color:dark?"#94a3b8":"#6b7280",fontSize:13,marginBottom:16,textAlign:"center"}}>Inserisci il codice che ti ha mandato il tuo tecnico</p>
        <input value={code} onChange={e=>setCode(e.target.value)} placeholder="Es. OT-2025-XK9A"
          style={{...inp,textTransform:"uppercase",fontFamily:"monospace",fontSize:20,letterSpacing:3,textAlign:"center"}}/>
        {err&&<p style={{color:"#dc2626",fontSize:13,margin:"0 0 10px"}}>{err}</p>}
        <button onClick={checkCode} disabled={load||!code} className="btn-primary" style={{background:"#16a34a",marginBottom:0}}>
          {load?<span className="spinner"/>:"Verifica codice â†’"}
        </button>
      </>:<>
        <div style={{background:dark?"#1e3a1e":"#f0fdf4",border:"1px solid #86efac",borderRadius:10,padding:"8px 12px",marginBottom:14,fontSize:12,color:"#16a34a",textAlign:"center"}}>âœ… Codice valido! Sei associato al tuo tecnico.</div>
        <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Nome e cognome</label>
        <input value={name} onChange={e=>setName(e.target.value)} placeholder="Mario Rossi" style={inp}/>
        <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Email</label>
        <input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="tuo@email.it" style={inp}/>
        <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Password (min. 6 caratteri)</label>
        <input type="password" value={pw} onChange={e=>setPw(e.target.value)} style={inp}/>
        <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Conferma password</label>
        <input type="password" value={pw2} onChange={e=>setPw2(e.target.value)} style={inp}/>
        {err&&<p style={{color:"#dc2626",fontSize:13,margin:"0 0 10px"}}>{err}</p>}
        <button onClick={doRegister} disabled={load} className="btn-primary" style={{background:"#16a34a",marginBottom:0}}>
          {load?<span className="spinner"/>:"Crea account ğŸ«’"}
        </button>
      </>}
    </div>}
  </div>);

  // forgot password
  return(<div style={{minHeight:"100vh",background:bg,display:"flex",alignItems:"center",justifyContent:"center",padding:24}}>
    <div style={{background:cardBg,borderRadius:24,padding:28,width:"100%",maxWidth:340}}>
      <button onClick={()=>setScreen("login")} style={{background:"none",border:"none",color:dark?"#94a3b8":"#6b7280",cursor:"pointer",marginBottom:16,fontSize:13}}>â† Torna al login</button>
      <h2 style={{fontFamily:"Lora,serif",marginBottom:8,color:dark?"#e2e8f0":"#052e16"}}>Reset password</h2>
      {sent?<>
        <p style={{color:dark?"#94a3b8":"#6b7280",marginBottom:16}}>âœ… Email inviata! Controlla la casella e segui il link.</p>
        <button onClick={()=>setScreen("login")} className="btn-primary" style={{background:"#16a34a",marginBottom:0}}>Torna al login</button>
      </>:<>
        <p style={{color:dark?"#94a3b8":"#6b7280",fontSize:13,marginBottom:16}}>Inserisci la tua email per ricevere il link di reset.</p>
        <input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="tuo@email.it" style={inp}/>
        <button onClick={doForgot} disabled={load||!email} className="btn-primary" style={{background:"#16a34a",marginBottom:0}}>
          {load?<span className="spinner"/>:"Invia link â†’"}
        </button>
      </>}
    </div>
  </div>);
}

// â•â•â•â•â•â•â•â•â•â•â• OLIVETO DETAIL â•â•â•â•â•â•â•â•â•â•â•
function OlivetoDetail({oliveto,user,onBack,nav,rils,sters,trats,traps,setTraps,dark}){
  const [tab,setTab]=useState("grafici");
  const myRil=[...rils].filter(r=>r.oId===oliveto.id).sort((a,b)=>b.data.localeCompare(a.data));
  const mySter=[...sters].filter(s=>s.oId===oliveto.id).sort((a,b)=>b.data.localeCompare(a.data));
  const myTrat=[...trats].filter(t=>t.oId===oliveto.id).sort((a,b)=>b.data.localeCompare(a.data));
  const lr=myRil[0],ls=mySter[0];
  const r=lr?rischio(lr.mosche):{l:"Nessun dato",c:"#9ca3af",bg:"rgba(156,163,175,0.1)",border:"#9ca3af"};
  const infD=ls?calcInf(ls):null;
  const cardBg=dark?"#1e293b":"white";
  const mutedC=dark?"#94a3b8":"#6b7280";

  const tabs=[["grafici","ğŸ“Š Grafici"],["trappole","ğŸª¤ Trappole"],["stereo","ğŸ”¬ Stereo"],["trattamenti","ğŸ’Š Trattamenti"]];

  return(
    <div>
      <div style={{background:dark?"#0a1f0f":"linear-gradient(135deg,#052e16,#166534)",padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif",margin:"0 0 4px",fontSize:20}}>{oliveto.nome}</h2>
        <p style={{color:"#86efac",margin:0,fontSize:13}}>{oliveto.loc} Â· {oliveto.var} Â· {oliveto.piante} piante Â· {oliveto.ha} ha</p>
        {oliveto.lat&&oliveto.lng&&(
          <a href={`https://www.google.com/maps?q=${oliveto.lat},${oliveto.lng}&z=16`} target="_blank" rel="noreferrer"
            style={{color:"#86efac",margin:"5px 0 0",fontSize:12,fontFamily:"monospace",display:"inline-flex",alignItems:"center",gap:5,textDecoration:"none",background:"rgba(255,255,255,0.12)",padding:"4px 10px",borderRadius:8,cursor:"pointer"}}>
            ğŸ“ {oliveto.lat}, {oliveto.lng} <span style={{fontSize:11,opacity:0.8}}>â†— Maps</span>
          </a>
        )}
      </div>
      <div style={{padding:"12px 14px 0",display:"flex",gap:10}}>
        {lr&&<div style={{flex:1,background:r.bg,border:`1.5px solid ${r.border}`,borderRadius:14,padding:12}}>
          <div style={{fontSize:10,fontWeight:700,color:mutedC,marginBottom:3}}>ULTIMA TRAPPOLA</div>
          <div style={{fontSize:28,fontWeight:700,color:r.c,fontFamily:"Lora,serif"}}>{lr.mosche}</div>
          <div style={{fontSize:11,color:mutedC}}>mosche Â· {lr.data}</div>
          <span className="tag" style={{background:r.c,color:"white",marginTop:6}}>{r.l}</span>
        </div>}
        {infD&&<div style={{flex:1,background:cardBg,border:`1.5px solid ${dark?"#334155":"#e0e7ff"}`,borderRadius:14,padding:12}}>
          <div style={{fontSize:10,fontWeight:700,color:mutedC,marginBottom:6}}>STEREOSCOPIO</div>
          {[["Attiva",infD.att,"#d97706"],["Totale",infD.tot,"#7c3aed"]].map(([lbl,val,color])=>(
            <div key={lbl} style={{marginBottom:6}}>
              <div style={{fontSize:10,color,fontWeight:700}}>{lbl}</div>
              <div className="inf-bar-bg" style={{marginTop:2}}><div className="inf-bar-fill" style={{width:`${val}%`,background:color}}/></div>
              <div style={{fontSize:13,fontWeight:700,color,textAlign:"right"}}>{val.toFixed(1)}%</div>
            </div>
          ))}
        </div>}
      </div>
      <div style={{display:"flex",gap:6,padding:"12px 14px 0",overflowX:"auto"}}>
        {tabs.map(([id,lbl])=>(
          <button key={id} onClick={()=>setTab(id)}
            style={{flexShrink:0,padding:"8px 12px",borderRadius:10,border:"none",cursor:"pointer",fontSize:12,fontWeight:600,background:tab===id?"#16a34a":(dark?"#1e3a1e":"#f0fdf4"),color:tab===id?"white":(dark?"#4ade80":"#16a34a")}}>
            {lbl}
          </button>
        ))}
      </div>
      <div style={{padding:14}}>
        {tab==="grafici"&&<>
          <h4 style={{margin:"0 0 12px",fontFamily:"Lora,serif",fontSize:16}}>Andamento monitoraggio</h4>
          <div style={{background:cardBg,borderRadius:14,padding:16,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.06)",marginBottom:14}}>
            <DualChart oId={oliveto.id} rils={rils} sters={sters} showSeason={true} dark={dark}/>
          </div>
          <div style={{display:"flex",gap:10}}>
            {[["Ril.",myRil.length,"ğŸª¤"],["Stereo",mySter.length,"ğŸ”¬"],["Tratt.",myTrat.length,"ğŸ’Š"]].map(([lbl,val,icon])=>(
              <div key={lbl} style={{flex:1,background:cardBg,borderRadius:12,padding:12,textAlign:"center",boxShadow:dark?"0 2px 8px rgba(0,0,0,0.3)":"0 2px 8px rgba(0,0,0,0.06)"}}>
                <div style={{fontSize:18}}>{icon}</div>
                <div style={{fontSize:22,fontWeight:700,fontFamily:"Lora,serif"}}>{val}</div>
                <div style={{fontSize:11,color:mutedC}}>{lbl}</div>
              </div>
            ))}
          </div>
        </>}
        {tab==="trappole"&&<>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
            <h4 style={{fontFamily:"Lora,serif",fontSize:16}}>Monitoraggi trappole</h4>
            {user.role==="admin"&&<button onClick={()=>nav("gestione-trappole",{oId:oliveto.id,oliveto})}
              style={{background:dark?"#1e3a1e":"#f0fdf4",border:"none",color:"#16a34a",padding:"6px 12px",borderRadius:8,fontSize:12,fontWeight:700,cursor:"pointer"}}>
              âš™ï¸ Gestisci trappole
            </button>}
          </div>
          {myRil.length===0&&<p style={{color:mutedC,textAlign:"center",padding:20}}>Nessun monitoraggio ancora</p>}
          {myRil.map(r=>{const rr=rischio(r.mosche);return(
            <div key={r.id} style={{background:cardBg,borderRadius:12,padding:14,marginBottom:10,boxShadow:dark?"0 1px 6px rgba(0,0,0,0.3)":"0 1px 6px rgba(0,0,0,0.06)",display:"flex",justifyContent:"space-between"}}>
              <div><div style={{fontWeight:700}}>{r.data}</div><div style={{fontSize:12,color:mutedC}}>{r.trappola||"â€”"} Â· {r.meteo}</div><div style={{fontSize:12,color:mutedC}}>{r.fase}</div></div>
              <div style={{textAlign:"right"}}><div style={{fontSize:28,fontWeight:700,color:rr.c,fontFamily:"Lora,serif"}}>{r.mosche}</div><span className="tag" style={{background:rr.c,color:"white"}}>{rr.l}</span></div>
            </div>);})}
        </>}
        {tab==="stereo"&&<>
          <h4 style={{margin:"0 0 12px",fontFamily:"Lora,serif",fontSize:16}}>Controlli stereoscopio</h4>
          {mySter.length===0&&<p style={{color:mutedC,textAlign:"center",padding:20}}>Nessun controllo ancora</p>}
          {mySter.map(s=>{const i=calcInf(s);return(
            <div key={s.id} style={{background:cardBg,borderRadius:14,padding:16,marginBottom:12,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
              <div style={{display:"flex",justifyContent:"space-between",marginBottom:12}}>
                <div style={{fontWeight:700,fontFamily:"Lora,serif"}}>{s.data}</div>
                <div style={{fontSize:12,color:mutedC}}>{s.camp} olive Â· stagione {s.stagione}</div>
              </div>
              <InfBar label="Inf. ATTIVA (Uova+L1+L2)" value={i.att} color={cInf(i.att)}/>
              <InfBar label="Inf. TOTALE (tutti gli stadi)" value={i.tot} color={i.tot>20?"#dc2626":"#7c3aed"}/>
              <div style={{display:"flex",gap:6,flexWrap:"wrap",marginTop:10}}>
                {[["ğŸ¥š",s.uova,"#f59e0b"],["L1",s.l1,"#10b981"],["L2",s.l2,"#059669"],["L3",s.l3,"#047857"],["Pupe",s.pupe,"#7c3aed"],["Fori",s.fori,"#6b7280"]].map(([lbl,val,color])=>(
                  <div key={lbl} style={{background:dark?"#273549":"#f9fafb",borderRadius:8,padding:"4px 8px",textAlign:"center"}}>
                    <div style={{fontSize:14,fontWeight:700,color}}>{val}</div><div style={{fontSize:10,color:mutedC}}>{lbl}</div>
                  </div>
                ))}
              </div>
            </div>);})}
        </>}
        {tab==="trattamenti"&&<>
          <h4 style={{margin:"0 0 12px",fontFamily:"Lora,serif",fontSize:16}}>Trattamenti effettuati</h4>
          {myTrat.length===0&&<p style={{color:mutedC,textAlign:"center",padding:20}}>Nessun trattamento registrato</p>}
          {myTrat.map(t=>(
            <div key={t.id} style={{background:cardBg,borderRadius:12,padding:14,marginBottom:10,boxShadow:dark?"0 1px 6px rgba(0,0,0,0.3)":"0 1px 6px rgba(0,0,0,0.06)"}}>
              <div style={{fontWeight:700}}>{t.data} Â· {t.prodotto}</div>
              {t.dose&&<div style={{fontSize:12,color:mutedC,marginTop:2}}>Dose: {t.dose}</div>}
              {t.note&&<div style={{fontSize:12,color:mutedC}}>{t.note}</div>}
            </div>
          ))}
          {user.role==="client"&&<button onClick={()=>nav("add-trattamento",oliveto)}
            style={{width:"100%",padding:14,background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"2px dashed #86efac",borderRadius:14,fontSize:15,fontWeight:600,cursor:"pointer",marginTop:4}}>
            + Aggiungi trattamento
          </button>}
        </>}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â• CLIENT HOME â•â•â•â•â•â•â•â•â•â•â•
function ClientHome({user,oliveti,rils,sters,trats,nav,dark}){
  const myOl=oliveti.filter(o=>o.cId===user.id);
  const alerts=myOl.filter(o=>{const l=lastOf(rils,"oId",o.id);return l&&l.mosche>=SA;});
  const cardBg=dark?"#1e293b":"white";
  const mutedC=dark?"#94a3b8":"#6b7280";
  return(
    <div>
      <div style={{background:dark?"linear-gradient(135deg,#051a08,#0a2e0a)":"linear-gradient(135deg,#052e16,#166534)",padding:"28px 20px 40px",borderRadius:"0 0 28px 28px"}}>
        <p style={{color:"#86efac",margin:"0 0 4px",fontSize:13}}>Benvenuto,</p>
        <h2 style={{color:"white",margin:0,fontSize:22,fontFamily:"Lora,serif"}}>{user.name}</h2>
        <div style={{display:"flex",gap:10,marginTop:20}}>
          {[[myOl.length,"ğŸ«’","Oliveti"],[alerts.length,"âš ï¸","Alert",alerts.length>0],[trats.filter(t=>t.cId===user.id).length,"ğŸ’Š","Trattamenti"]].map(([val,icon,lbl,alert])=>(
            <div key={lbl} style={{flex:1,background:alert?"rgba(220,38,38,0.3)":"rgba(255,255,255,0.13)",borderRadius:14,padding:"12px 8px",textAlign:"center"}}>
              <div style={{fontSize:22}}>{icon}</div><div style={{color:"white",fontSize:24,fontWeight:700,fontFamily:"Lora,serif"}}>{val}</div><div style={{color:"#86efac",fontSize:11}}>{lbl}</div>
            </div>
          ))}
        </div>
      </div>
      <div style={{padding:"16px 14px 0"}}>
        {alerts.length>0&&<div style={{background:"rgba(220,38,38,0.1)",border:"1.5px solid rgba(220,38,38,0.3)",borderRadius:14,padding:14,marginBottom:14}}>
          <strong style={{color:"#dc2626"}}>âš ï¸ Soglia superata!</strong>
          {alerts.map(o=>{const l=lastOf(rils,"oId",o.id);return(
            <div key={o.id} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",borderTop:`1px solid rgba(220,38,38,0.2)`,marginTop:6}}>
              <span style={{fontSize:13}}>{o.nome}</span>
              <span className="tag" style={{background:"#dc2626",color:"white"}}>{l.mosche} mosche</span>
            </div>);})}
        </div>}
        <h3 style={{margin:"0 0 12px",fontFamily:"Lora,serif",fontSize:17}}>I tuoi oliveti</h3>
        {myOl.map(o=>{
          const lr=lastOf(rils,"oId",o.id),ls=lastOf(sters,"oId",o.id);
          const r=lr?rischio(lr.mosche):{l:"â€”",c:"#9ca3af",bg:"rgba(156,163,175,0.1)",border:"#9ca3af"};
          const i=ls?calcInf(ls):null;
          return(
            <div key={o.id} onClick={()=>nav("oliveto-detail",o)} style={{background:cardBg,borderRadius:18,padding:16,marginBottom:12,boxShadow:dark?"0 2px 14px rgba(0,0,0,0.4)":"0 2px 14px rgba(0,0,0,0.07)",cursor:"pointer"}} className="card fade-in">
              <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:i?10:0}}>
                <div style={{fontSize:34}}>ğŸ«’</div>
                <div style={{flex:1}}>
                  <div style={{fontWeight:700,fontSize:15,fontFamily:"Lora,serif"}}>{o.nome}</div>
                  <div style={{fontSize:12,color:mutedC}}>{o.loc} Â· {o.var}</div>
                  {lr&&<div style={{fontSize:12,color:mutedC}}>ğŸª¤ {lr.data}: {lr.mosche} mosche</div>}
                </div>
                <div className="tag" style={{background:r.bg,color:r.c,border:`1px solid ${r.border}`}}>{r.l}</div>
              </div>
              {i&&<div style={{paddingTop:10,borderTop:`1px solid ${dark?"#334155":"#f3f4f6"}`,display:"flex",gap:8,alignItems:"center"}}>
                <span style={{fontSize:11,color:mutedC,flexShrink:0}}>ğŸ”¬ Att.</span>
                <div className="inf-bar-bg" style={{flex:1}}><div className="inf-bar-fill" style={{width:`${i.att}%`,background:cInf(i.att)}}/></div>
                <span style={{fontSize:12,fontWeight:700,color:cInf(i.att),minWidth:38,textAlign:"right"}}>{i.att.toFixed(1)}%</span>
                <span style={{fontSize:11,color:mutedC,flexShrink:0}}>Tot.</span>
                <div className="inf-bar-bg" style={{flex:1}}><div className="inf-bar-fill" style={{width:`${i.tot}%`,background:"#7c3aed"}}/></div>
                <span style={{fontSize:12,fontWeight:700,color:"#7c3aed",minWidth:38,textAlign:"right"}}>{i.tot.toFixed(1)}%</span>
              </div>}
            </div>
          );
        })}
        <button onClick={()=>nav("add-oliveto")} style={{width:"100%",padding:14,background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"2px dashed #86efac",borderRadius:14,fontSize:15,fontWeight:600,cursor:"pointer"}}>
          + Aggiungi oliveto
        </button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â• ADMIN HOME â•â•â•â•â•â•â•â•â•â•â•
function AdminHome({oliveti,rils,sters,trats,nav,dark,clients=[]}){
  const alerts=oliveti.filter(o=>{const l=lastOf(rils,"oId",o.id);return l&&l.mosche>=SA;}).length;
  const cardBg=dark?"#1e293b":"white";
  const mutedC=dark?"#94a3b8":"#6b7280";
  return(
    <div>
      <div style={{background:dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)",padding:"28px 20px 40px",borderRadius:"0 0 28px 28px"}}>
        <p style={{color:"#a5b4fc",margin:"0 0 4px",fontSize:13}}>Pannello Admin</p>
        <h2 style={{color:"white",margin:0,fontSize:22,fontFamily:"Lora,serif"}}>Dashboard</h2>
        <div style={{display:"flex",gap:8,marginTop:18,flexWrap:"wrap"}}>
          {[[clients.length,"ğŸ‘¥","Clienti"],[oliveti.length,"ğŸ«’","Oliveti"],[rils.length,"ğŸª¤","Trappole"],[sters.length,"ğŸ”¬","Stereo"],[alerts,"âš ï¸","Alert",alerts>0]].map(([val,icon,lbl,alert])=>(
            <div key={lbl} style={{background:alert?"rgba(220,38,38,0.3)":"rgba(255,255,255,0.1)",borderRadius:12,padding:"10px 14px",textAlign:"center",minWidth:55}}>
              <div style={{fontSize:18}}>{icon}</div><div style={{color:"white",fontSize:20,fontWeight:700,fontFamily:"Lora,serif"}}>{val}</div><div style={{color:"#a5b4fc",fontSize:10}}>{lbl}</div>
            </div>
          ))}
        </div>
      </div>
      <div style={{padding:"16px 14px 0"}}>
        <div style={{display:"flex",gap:10,marginBottom:16}}>
          <button onClick={()=>nav("add-rilevamento")} style={{flex:1,padding:13,background:dark?"#1e1b4b":"#3730a3",color:"white",border:"none",borderRadius:14,fontSize:13,fontWeight:700,cursor:"pointer"}}>ğŸª¤ Nuovo monitoraggio</button>
          <button onClick={()=>nav("add-stereoscopio")} style={{flex:1,padding:13,background:dark?"#051505":"#052e16",color:"white",border:"none",borderRadius:14,fontSize:13,fontWeight:700,cursor:"pointer"}}>ğŸ”¬ Campionamento</button>
        </div>
        <h3 style={{margin:"0 0 12px",fontFamily:"Lora,serif",fontSize:17}}>Clienti</h3>
        {clients.map(c=>{
          const myOl=oliveti.filter(o=>o.cId===c.id);
          const myA=myOl.filter(o=>{const l=lastOf(rils,"oId",o.id);return l&&l.mosche>=SA;}).length;
          const ls=sters.filter(s=>s.cId===c.id).sort((a,b)=>b.data.localeCompare(a.data))[0];
          const i=ls?calcInf(ls):null;
          return(
            <div key={c.id} onClick={()=>nav("client-detail",c)} style={{background:cardBg,borderRadius:18,padding:16,marginBottom:12,boxShadow:dark?"0 2px 14px rgba(0,0,0,0.4)":"0 2px 14px rgba(0,0,0,0.07)",cursor:"pointer"}} className="card fade-in">
              <div style={{display:"flex",alignItems:"center",gap:12}}>
                <div style={{width:44,height:44,borderRadius:22,background:dark?"#2d2b6b":"#e0e7ff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22}}>ğŸ‘¤</div>
                <div style={{flex:1}}><div style={{fontWeight:700,fontFamily:"Lora,serif"}}>{c.name}</div><div style={{fontSize:12,color:mutedC}}>{myOl.length} oliveti</div></div>
                {myA>0&&<div className="tag" style={{background:"#dc2626",color:"white"}}>âš ï¸ {myA}</div>}
              </div>
              {i&&<div style={{marginTop:10,paddingTop:10,borderTop:`1px solid ${dark?"#334155":"#f3f4f6"}`,display:"flex",gap:8,alignItems:"center"}}>
                <span style={{fontSize:11,color:mutedC}}>ğŸ”¬ Attiva:</span>
                <div className="inf-bar-bg" style={{flex:1}}><div className="inf-bar-fill" style={{width:`${i.att}%`,background:cInf(i.att)}}/></div>
                <span style={{fontSize:12,fontWeight:700,color:cInf(i.att)}}>{i.att.toFixed(1)}%</span>
              </div>}
            </div>
          );
        })}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â• ADMIN CLIENT DETAIL â•â•â•â•â•â•â•â•â•â•â•
function AdminClientDetail({client,oliveti,rils,sters,traps,setTraps,onBack,nav,dark}){
  const myOl=oliveti.filter(o=>o.cId===client.id);
  const cardBg=dark?"#1e293b":"white";
  const mutedC=dark?"#94a3b8":"#6b7280";
  return(
    <div>
      <div style={{background:dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)",padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>{client.name}</h2>
        <p style={{color:"#a5b4fc",margin:"4px 0 0",fontSize:13}}>{client.email}</p>
      </div>
      <div style={{padding:14}}>
        <div style={{display:"flex",gap:10,marginBottom:14}}>
          <button onClick={()=>nav("add-rilevamento",{preClient:client})} style={{flex:1,padding:12,background:dark?"#1e1b4b":"#3730a3",color:"white",border:"none",borderRadius:12,fontSize:13,fontWeight:700,cursor:"pointer"}}>ğŸª¤ Monitoraggio</button>
          <button onClick={()=>nav("add-stereoscopio",{preClient:client})} style={{flex:1,padding:12,background:dark?"#051505":"#052e16",color:"white",border:"none",borderRadius:12,fontSize:13,fontWeight:700,cursor:"pointer"}}>ğŸ”¬ Campionamento</button>
        </div>
        {myOl.map(o=>{
          return(
            <div key={o.id} onClick={()=>nav("admin-oliveto",{oliveto:o,client})} style={{background:cardBg,borderRadius:14,padding:16,marginBottom:10,boxShadow:dark?"0 2px 14px rgba(0,0,0,0.4)":"0 2px 14px rgba(0,0,0,0.07)",cursor:"pointer",display:"flex",alignItems:"center",gap:12}} className="card">
              <div style={{fontSize:28}}>ğŸ«’</div>
              <div style={{fontWeight:700,fontFamily:"Lora,serif",fontSize:15}}>{o.nome}</div>
              <div style={{marginLeft:"auto",fontSize:18,color:mutedC}}>â€º</div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â• FORMS (Add Oliveto, Rilevamento, Stereo, Trattamento) â•â•â•â•â•â•â•â•â•â•â•
function FormPage({title,gradient,children}){
  return(
    <div>
      <div style={{background:gradient,padding:"20px 20px 28px"}}>
        {children[0]}
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>{title}</h2>
      </div>
      <div style={{padding:16}}>{children.slice(1)}</div>
    </div>
  );
}

function FieldInput({label,value,onChange,type="text",placeholder="",dark,borderColor}){
  const bc=borderColor||(dark?"#2d4a2d":"#d1fae5");
  return(
    <div style={{marginBottom:14}}>
      <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>{label}</label>
      <input type={type} value={value} onChange={onChange} placeholder={placeholder}
        style={{width:"100%",padding:"10px 14px",border:`1.5px solid ${bc}`,borderRadius:10,fontSize:14,outline:"none",boxSizing:"border-box",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e"}}/>
    </div>
  );
}

function AddOliveto({user,onBack,onSave,dark}){
  const [f,setF]=useState({nome:"",loc:"",piante:"",var:"",ha:"",lat:"",lng:""});
  const [showMap,setShowMap]=useState(false);
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  function save(){if(!f.nome||!f.loc){alert("Nome e localitÃ  obbligatori");return;}onSave({...f,id:"ol"+Date.now(),cId:user.id});}
  const grad=dark?"linear-gradient(135deg,#051a08,#0a2e0a)":"linear-gradient(135deg,#052e16,#166534)";
  const backBtn=<button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>;

  // Use a portal so the modal is never clipped by parent overflow:hidden
  const mapModal = showMap ? createPortal(
    <MapPicker
      initLat={f.lat?+f.lat:43.7}
      initLng={f.lng?+f.lng:8.0}
      onConfirm={(la,lo)=>{set("lat",la+"");set("lng",lo+"");setShowMap(false);}}
      onClose={()=>setShowMap(false)}
      dark={dark}
    />,
    document.body
  ) : null;

  return(<>
    {mapModal}
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>{backBtn}<h2 style={{color:"white",fontFamily:"Lora,serif"}}>Nuovo oliveto</h2></div>
      <div style={{padding:16}}>
        {[["nome","Nome oliveto *"],["loc","LocalitÃ  / Comune *"],["var","VarietÃ ","Es. Taggiasca"],["piante","NÂ° piante","Es. 320","number"],["ha","Ettari","Es. 2.5","number"]].map(([k,lbl,ph="",type="text"])=>(
          <FieldInput key={k} label={lbl} value={f[k]} onChange={e=>set(k,e.target.value)} type={type} placeholder={ph} dark={dark}/>
        ))}
        <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:8}}>Coordinate GPS</label>
        {f.lat&&f.lng?(
          <div style={{background:dark?"#1e3a1e":"#f0fdf4",border:"1.5px solid #86efac",borderRadius:12,padding:14,display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
            <div><div style={{fontSize:13,color:"#4ade80",fontWeight:600}}>ğŸ“ Posizione impostata</div>
              <div style={{fontSize:12,color:dark?"#94a3b8":"#6b7280",fontFamily:"monospace"}}>{f.lat}, {f.lng}</div></div>
            <button onClick={()=>setShowMap(true)} style={{background:"#16a34a",color:"white",border:"none",borderRadius:8,padding:"6px 12px",cursor:"pointer",fontSize:12,fontWeight:700}}>âœï¸ Modifica</button>
          </div>
        ):(
          <button onClick={()=>setShowMap(true)} className="btn-primary" style={{background:dark?"#051505":"#052e16",display:"flex",alignItems:"center",justifyContent:"center",gap:8}}>ğŸ—ºï¸ Apri mappa</button>
        )}
        <button onClick={save} className="btn-primary" style={{background:"#16a34a"}}>ğŸ’¾ Salva oliveto</button>
      </div>
    </div>
  </>);
}

function AddTrattamento({oliveto,user,onBack,onSave,dark}){
  const [f,setF]=useState({data:new Date().toISOString().slice(0,10),prodotto:"",dose:"",note:""});
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const grad=dark?"linear-gradient(135deg,#051a08,#0a2e0a)":"linear-gradient(135deg,#052e16,#166534)";
  function save(){if(!f.prodotto){alert("Inserisci il prodotto");return;}onSave({...f,id:"t"+Date.now(),oId:oliveto.id,cId:user.id});}
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>Nuovo trattamento</h2>
        <p style={{color:"#86efac",margin:"4px 0 0",fontSize:13}}>{oliveto.nome}</p>
      </div>
      <div style={{padding:16}}>
        {[["data","Data","date"],["prodotto","Prodotto *","text"],["dose","Dose","text"],["note","Note","text"]].map(([k,lbl,type])=>(
          <FieldInput key={k} label={lbl} value={f[k]} onChange={e=>set(k,e.target.value)} type={type} dark={dark}/>
        ))}
        <button onClick={save} className="btn-primary" style={{background:"#16a34a"}}>ğŸ’¾ Salva trattamento</button>
      </div>
    </div>
  );
}

function AddRilevamento({oliveti,traps,onBack,onSave,preClient,dark}){
  const [oId,setOId]=useState(""),[trapId,setTrapId]=useState("");
  const [f,setF]=useState({data:new Date().toISOString().slice(0,10),mosche:"",meteo:"Soleggiato",fase:"Allegagione"});
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const myTraps=(traps||[]).filter(t=>(t.oliveto_id||t.oId)===oId&&t.attiva);
  const m=parseInt(f.mosche)||0;
  const selStyle={width:"100%",padding:"10px 14px",border:`1.5px solid ${dark?"#2d2b6b":"#ddd5fe"}`,borderRadius:10,fontSize:14,outline:"none",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e"};

  function save(){
    if(!oId||!trapId||!f.mosche){alert("Compila tutti i campi obbligatori");return;}
    onSave({...f,mosche:m,oId,trapId});
  }

  const grad=dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)";
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸª¤ Nuovo monitoraggio</h2>
      </div>
      <div style={{padding:16}}>
        {/* Oliveto */}
        <div style={{marginBottom:14}}>
          <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Oliveto *</label>
<select value={oId} onChange={e=>{setOId(e.target.value);setTrapId("");}} style={selStyle}>
  <option value="">â€” seleziona â€”</option>
  {oliveti
    .filter(o => !preClient || o.user_id === preClient.id || o.cId === preClient.id) // Filtro aggiunto
    .map(o => (
      <option key={o.id} value={o.id}>{o.nome} ({o.loc || ""})</option>
    ))
  }
</select>

        </div>
        {/* Trappola */}
        <div style={{marginBottom:14}}>
          <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Trappola *</label>
          {oId&&myTraps.length===0?(
            <div style={{background:"rgba(220,38,38,0.1)",border:"1.5px solid #dc2626",borderRadius:10,padding:"10px 14px",fontSize:13,color:"#dc2626"}}>
              âš ï¸ Nessuna trappola attiva per questo oliveto. <strong>Aggiungila prima dalla scheda oliveto.</strong>
            </div>
          ):(
            <select value={trapId} onChange={e=>setTrapId(e.target.value)} disabled={!oId} style={{...selStyle,opacity:!oId?0.5:1}}>
              <option value="">â€” seleziona trappola â€”</option>
              {myTraps.map(t=><option key={t.id} value={t.id}>{t.nome} ({t.tipo})</option>)}
            </select>
          )}
        </div>
        {/* Data */}
        <FieldInput label="Data *" value={f.data} onChange={e=>set("data",e.target.value)} type="date" dark={dark} borderColor={dark?"#2d2b6b":"#ddd5fe"}/>
        {/* Mosche */}
        <FieldInput label="Mosche catturate *" value={f.mosche} onChange={e=>set("mosche",e.target.value)} type="number" placeholder="Es. 25" dark={dark} borderColor={dark?"#2d2b6b":"#ddd5fe"}/>
        {/* Meteo + Fase */}
        {[["meteo","Meteo",["Soleggiato","Nuvoloso","Variabile","Caldo umido","Fresco","Piovoso"]],
          ["fase","Fase fenologica",["Allegagione","Ingrossamento frutto","Indurimento nocciolo","Invaiatura","Maturazione","Raccolta"]]
        ].map(([k,lbl,opts])=>(
          <div key={k} style={{marginBottom:14}}>
            <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>{lbl}</label>
            <select value={f[k]} onChange={e=>set(k,e.target.value)} style={selStyle}>
              {opts.map(o=><option key={o} value={o}>{o}</option>)}
            </select>
          </div>
        ))}
        {m>=SA&&<div style={{background:m>=SP?"rgba(220,38,38,0.1)":"rgba(217,119,6,0.1)",border:`1.5px solid ${m>=SP?"#dc2626":"#d97706"}`,borderRadius:12,padding:12,marginBottom:14}}>
          <strong style={{color:m>=SP?"#dc2626":"#d97706"}}>{m>=SP?"ğŸš¨ Soglia PERICOLO superata!":"âš ï¸ Soglia ALLERTA superata!"}</strong>
        </div>}
        <button onClick={save} className="btn-primary" style={{background:dark?"#2d2b6b":"#3730a3"}}>ğŸ’¾ Salva monitoraggio</button>
      </div>
    </div>
  );
}

function AddStereoscopio({oliveti,onBack,onSave,preClient,dark}){
  const [oId,setOId]=useState("");
  const [f,setF]=useState({data:new Date().toISOString().slice(0,10),camp:"100",uova:"0",l1:"0",l2:"0",l3:"0",pupe:"0",fori:"0"});
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const n=k=>parseInt(f[k])||0;
  const camp=n("camp"),uova=n("uova"),l1=n("l1"),l2=n("l2"),l3=n("l3"),pupe=n("pupe"),fori=n("fori");
  const att=camp>0?Math.min(((uova+l1+l2)/camp)*100,100):0;
  const tot=camp>0?Math.min(((uova+l1+l2+l3+pupe+fori)/camp)*100,100):0;
  const selStyle={width:"100%",padding:"10px 14px",border:`1.5px solid ${dark?"#2d2b6b":"#ddd5fe"}`,borderRadius:10,fontSize:14,outline:"none",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e"};
  function save(){if(!oId||!f.camp){alert("Seleziona oliveto e inserisci nÂ° campioni");return;}onSave({data:f.data,camp,uova,l1,l2,l3,pupe,fori,oId,stagione:new Date(f.data).getFullYear()});}
  const cardBg=dark?"#1e293b":"white";
  const stadi=[["uova","ğŸ¥š Uova","#f59e0b",true],["l1","L1","#10b981",true],["l2","L2","#059669",true],["l3","L3","#047857",false],["pupe","ğŸ«˜ Pupe","#7c3aed",false],["fori","ğŸ•³ï¸ Fori","#6b7280",false]];
  const grad=dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)";
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸ”¬ Campionamento stereoscopio</h2>
      </div>
      <div style={{padding:16}}>
        <div style={{marginBottom:14}}><label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Oliveto *</label>
<select value={oId} onChange={e=>setOId(e.target.value)} style={selStyle}>
  <option value="">â€” seleziona â€”</option>
  {oliveti
    .filter(o => !preClient || o.user_id === preClient.id || o.cId === preClient.id) // Filtro aggiunto
    .map(o => (
      <option key={o.id} value={o.id}>{o.nome} ({o.loc || ""})</option>
    ))
  }
</select>
</div>
        <FieldInput label="Data *" value={f.data} onChange={e=>set("data",e.target.value)} type="date" dark={dark} borderColor={dark?"#2d2b6b":"#ddd5fe"}/>
        <FieldInput label="NÂ° olive campionate *" value={f.camp} onChange={e=>set("camp",e.target.value)} type="number" dark={dark} borderColor={dark?"#2d2b6b":"#ddd5fe"}/>
        <div style={{background:cardBg,borderRadius:16,padding:16,marginBottom:16,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
          <h4 style={{margin:"0 0 14px",fontFamily:"Lora,serif",fontSize:15}}>Stadi rilevati (nÂ° olive)</h4>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
            {stadi.map(([k,lbl,color,isAtt])=>(
              <div key={k}>
                <label style={{display:"block",fontSize:11,fontWeight:700,color,marginBottom:5}}>
                  {lbl} {isAtt&&<span style={{background:"rgba(253,224,71,0.2)",color:"#d97706",padding:"1px 5px",borderRadius:4,fontSize:9,fontWeight:700}}>ATTIVA</span>}
                </label>
                <input type="number" min="0" value={f[k]} onChange={e=>set(k,e.target.value)}
                  style={{width:"100%",padding:"9px",border:`1.5px solid ${color}40`,borderRadius:10,fontSize:18,fontWeight:700,outline:"none",boxSizing:"border-box",textAlign:"center",color,background:dark?"#273549":"white"}}/>
              </div>
            ))}
          </div>
        </div>
        {camp>0&&<div style={{background:cardBg,borderRadius:16,padding:16,marginBottom:16,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
          <h4 style={{margin:"0 0 12px",fontFamily:"Lora,serif",fontSize:14}}>ğŸ“Š Anteprima</h4>
          <InfBar label="Inf. ATTIVA (Uova+L1+L2)" value={att} color={cInf(att)}/>
          <InfBar label="Inf. TOTALE (tutti gli stadi)" value={tot} color={tot>20?"#dc2626":tot>10?"#d97706":"#7c3aed"}/>
          <div style={{display:"flex",gap:8,marginTop:10}}>
            {[["Attive",uova+l1+l2,"#16a34a"],["Totali",uova+l1+l2+l3+pupe+fori,"#3730a3"],["Camp.",camp,"#64748b"]].map(([lbl,val,color])=>(
              <div key={lbl} style={{flex:1,background:dark?"#273549":"#f0fdf4",borderRadius:10,padding:10,textAlign:"center"}}>
                <div style={{fontSize:20,fontWeight:700,color,fontFamily:"Lora,serif"}}>{val}</div><div style={{fontSize:10,color:dark?"#64748b":"#6b7280"}}>{lbl}</div>
              </div>
            ))}
          </div>
        </div>}
        <button onClick={save} className="btn-primary" style={{background:dark?"#2d2b6b":"#3730a3"}}>ğŸ’¾ Salva campionamento</button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â• SOGLIE â•â•â•â•â•â•â•â•â•â•â•
function Soglie({onBack,dark}){
  const [s1,setS1]=useState(SA),[s2,setS2]=useState(SP),[ok,setOk]=useState(false);
  function save(){SA=+s1;SP=+s2;setOk(true);setTimeout(()=>setOk(false),2000);}
  const cardBg=dark?"#1e293b":"white";
  const grad=dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)";
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>âš™ï¸ Soglie di allerta</h2>
      </div>
      <div style={{padding:16}}>
        <div style={{background:cardBg,borderRadius:16,padding:20,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)",marginBottom:16}}>
          {[["âš ï¸ Soglia ALLERTA","#d97706",s1,setS1],["ğŸš¨ Soglia PERICOLO","#dc2626",s2,setS2]].map(([lbl,color,val,fn])=>(
            <div key={lbl} style={{marginBottom:18}}>
              <label style={{display:"block",fontSize:13,fontWeight:600,marginBottom:6,color}}>{lbl}</label>
              <input type="number" value={val} onChange={e=>fn(e.target.value)}
                style={{width:"100%",padding:"11px 14px",border:`1.5px solid ${color}60`,borderRadius:10,fontSize:20,fontWeight:700,outline:"none",boxSizing:"border-box",background:dark?"#273549":"white",color:dark?"#e2e8f0":"#1a1a2e"}}/>
            </div>
          ))}
          <button onClick={save} className="btn-primary" style={{background:ok?"#16a34a":(dark?"#2d2b6b":"#3730a3"),transition:"background 0.3s",marginBottom:0}}>
            {ok?"âœ… Salvato!":"ğŸ’¾ Salva soglie"}
          </button>
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â• EXPORT â•â•â•â•â•â•â•â•â•â•â•
function Export({oliveti,rils,sters,onBack,dark}){
  const cardBg=dark?"#1e293b":"white";
  const grad=dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)";
  function dl(rows,name){
    const csv=rows.map(r=>r.join(",")).join("\n");
    const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));a.download=name;a.click();
  }
  function expRil(){const rows=[["Oliveto","Data","Mosche","Trappola","Meteo","Fase","Rischio","Stagione"]];rils.forEach(r=>{const o=oliveti.find(x=>x.id===(r.oId||r.oliveto_id));rows.push([o?.nome,r.data,r.mosche,r.trappola,r.meteo,r.fase,rischio(r.mosche).l,r.stagione]);});dl(rows,"olivetrack_trappole.csv");}
  function expSter(){const rows=[["Oliveto","Data","Campione","Uova","L1","L2","L3","Pupe","Fori","Att%","Tot%","Stagione"]];sters.forEach(s=>{const o=oliveti.find(x=>x.id===(s.oId||s.oliveto_id)),i=calcInf(s);rows.push([o?.nome,s.data,s.camp,s.uova,s.l1,s.l2,s.l3,s.pupe,s.fori,i.att.toFixed(1),i.tot.toFixed(1),s.stagione]);});dl(rows,"olivetrack_stereoscopio.csv");}
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸ“Š Export Report</h2>
      </div>
      <div style={{padding:16}}>
        <div style={{background:cardBg,borderRadius:16,padding:18,marginBottom:14,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
          {[["ğŸ‘¥ Clienti",clients.length],["ğŸ«’ Oliveti",oliveti.length],["ğŸª¤ Rilevamenti",rils.length],["ğŸ”¬ Stereoscopio",sters.length]].map(([l,v])=>(
            <div key={l} style={{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:`1px solid ${dark?"#334155":"#f3f4f6"}`,fontSize:14}}>
              <span>{l}</span><strong>{v}</strong>
            </div>
          ))}
        </div>
        <button onClick={expRil} className="btn-primary" style={{background:"#16a34a"}}>ğŸ“¥ Scarica CSV Trappole</button>
        <button onClick={expSter} className="btn-primary" style={{background:dark?"#2d2b6b":"#3730a3"}}>ğŸ“¥ Scarica CSV Stereoscopio</button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â• APP ROOT â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â• INVITE CODES (admin) â•â•â•â•â•â•â•â•â•â•â•
function InviteCodes({adminId,dark,onBack}){
  const [codes,setCodes]=useState([]);
  const [load,setLoad]=useState(true);
  const [gen,setGen]=useState(false);
  const [copied,setCopied]=useState(null);
  const cardBg=dark?"#1e293b":"white";
  const mutedC=dark?"#94a3b8":"#6b7280";
  useEffect(()=>{loadCodes();},[]);
  async function loadCodes(){
    setLoad(true);
    const{data}=await sb.from("invite_codes").select("*").eq("admin_id",adminId).order("created_at",{ascending:false}).limit(30);
    setCodes(data||[]);setLoad(false);
  }
  async function generate(){
    setGen(true);
    const code=genCode();
    const expires=new Date();expires.setDate(expires.getDate()+7);
    await sb.from("invite_codes").insert({code,admin_id:adminId,used:false,expires_at:expires.toISOString()});
    await loadCodes();setGen(false);
  }
  function copy(code){
    const msg=`Ciao! Ti invito ad usare OliveTrack per monitorare il tuo oliveto.\n\nApri l'app e inserisci questo codice:\n\nğŸ”‘ ${code}\n\n(valido 7 giorni)`;
    navigator.clipboard?.writeText(msg).then(()=>{setCopied(code);setTimeout(()=>setCopied(null),2500);});
  }
  const active=codes.filter(c=>!c.used&&new Date(c.expires_at)>new Date());
  const used=codes.filter(c=>c.used);
  return(<div>
    <div style={{background:dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)",padding:"20px 20px 28px"}}>
      <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
      <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸ”‘ Codici invito</h2>
      <p style={{color:"#a5b4fc",margin:"4px 0 0",fontSize:13}}>Genera un codice e mandalo al cliente via WhatsApp</p>
    </div>
    <div style={{padding:16}}>
      <button onClick={generate} disabled={gen} className="btn-primary" style={{background:"#3730a3",display:"flex",alignItems:"center",justifyContent:"center",gap:10}}>
        {gen?<span className="spinner"/>:"ğŸ”‘ Genera nuovo codice invito"}
      </button>
      {load?<p style={{textAlign:"center",color:mutedC,padding:20}}>Caricamento...</p>:<>
        {active.length>0&&<><h4 style={{fontFamily:"Lora,serif",margin:"12px 0 8px",fontSize:14}}>Attivi ({active.length})</h4>
        {active.map(c=><div key={c.id} style={{background:cardBg,borderRadius:14,padding:14,marginBottom:10,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
          <div style={{display:"flex",alignItems:"center",gap:12}}>
            <div style={{flex:1}}>
              <div style={{fontFamily:"monospace",fontSize:22,fontWeight:700,letterSpacing:3,color:"#3730a3"}}>{c.code}</div>
              <div style={{fontSize:11,color:mutedC}}>Scade: {new Date(c.expires_at).toLocaleDateString("it")}</div>
            </div>
            <button onClick={()=>copy(c.code)} style={{background:copied===c.code?"#16a34a":"#3730a3",color:"white",border:"none",borderRadius:10,padding:"8px 14px",cursor:"pointer",fontSize:12,fontWeight:700,transition:"background 0.2s",whiteSpace:"nowrap"}}>
              {copied===c.code?"âœ… Copiato!":"ğŸ“‹ Copia testo"}
            </button>
          </div>
        </div>)}</>}
        {used.length>0&&<><h4 style={{fontFamily:"Lora,serif",margin:"12px 0 8px",fontSize:13,color:mutedC}}>GiÃ  usati ({used.length})</h4>
        {used.map(c=><div key={c.id} style={{background:cardBg,borderRadius:10,padding:10,marginBottom:6,opacity:0.5,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <span style={{fontFamily:"monospace",fontSize:14,fontWeight:700,textDecoration:"line-through",color:mutedC}}>{c.code}</span>
          <span className="tag" style={{background:"#16a34a",color:"white"}}>âœ… Usato</span>
        </div>)}</>}
        {codes.length===0&&<div style={{textAlign:"center",padding:"30px 0",color:mutedC}}>
          <div style={{fontSize:40,marginBottom:8}}>ğŸ”‘</div>
          <p>Nessun codice ancora. Generane uno per invitare il tuo primo cliente!</p>
        </div>}
      </>}
    </div>
  </div>);
}

// â•â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â•â•
function App(){
  const [dark,setDark]=useState(()=>localStorage.getItem("ot_dark")==="1");
  const [session,setSession]=useState(undefined); // undefined=loading, null=logged out
  const [profile,setProfile]=useState(null);
  const [dataLoading,setDataLoading]=useState(false);
  const [page,setPage]=useState("home");
  const [pdata,setPdata]=useState(null);
  const [tab,setTab]=useState("home");
  const [oliveti,setOliveti]=useState([]);
  const [rils,setRils]=useState([]);
  const [sters,setSters]=useState([]);
  const [trats,setTrats]=useState([]);
  const [traps,setTraps]=useState([]);
  const [clients,setClients]=useState([]);
  const online=useOnline();

  function toggleDark(){setDark(d=>{localStorage.setItem("ot_dark",d?"0":"1");return !d;});}
  function nav(p,d=null){setPage(p);setPdata(d);}
  function goHome(){setPage("home");setPdata(null);}
  function goHomeClear(){setPage("home");setPdata(null);setTab("home");}

  // Auth listener
  useEffect(()=>{
    sb.auth.getSession().then(({data:{session}})=>{
      setSession(session);
      if(session) loadProfile(session.user);
    });
    const{data:{subscription}}=sb.auth.onAuthStateChange((_,session)=>{
      setSession(session);
      if(session) loadProfile(session.user);
      else{setProfile(null);setOliveti([]);setRils([]);setSters([]);setTrats([]);setTraps([]);setClients([]);}
    });
    return()=>subscription.unsubscribe();
  },[]);

  async function loadProfile(user){
    const meta=user.user_metadata||{};
    const p={id:user.id,email:user.email,name:meta.name||user.email.split("@")[0],role:meta.role||"client",admin_id:meta.admin_id||null};
    setProfile(p);
    await loadData(p);
  }

  async function loadData(p){
    setDataLoading(true);
    try{
      if(p.role==="admin"){
        const[{data:ol},{data:ri},{data:st},{data:tr},{data:tp},{data:cl}]=await Promise.all([
          sb.from("oliveti").select("*").eq("admin_id",p.id),
          sb.from("monitoraggi").select("*").eq("admin_id",p.id).order("data",{ascending:false}),
          sb.from("campionamenti").select("*").eq("admin_id",p.id).order("data",{ascending:false}),
          sb.from("trattamenti").select("*").eq("admin_id",p.id).order("data",{ascending:false}),
          sb.from("trappole").select("*").eq("admin_id",p.id),
          sb.from("profiles").select("*").eq("admin_id",p.id),
        ]);
        setOliveti(ol||[]);setRils(ri||[]);setSters(st||[]);setTrats(tr||[]);setTraps(tp||[]);setClients(cl||[]);
        Cache.set("ol",ol);Cache.set("ri",ri);Cache.set("st",st);Cache.set("tr",tr);Cache.set("tp",tp);Cache.set("cl",cl);
      } else {
        const{data:ol}=await sb.from("oliveti").select("*").eq("user_id",p.id);
        const ids=(ol||[]).map(o=>o.id);
        const[{data:ri},{data:st},{data:tr},{data:tp}]=await Promise.all([
          sb.from("monitoraggi").select("*").eq("user_id",p.id).order("data",{ascending:false}),
          sb.from("campionamenti").select("*").eq("user_id",p.id).order("data",{ascending:false}),
          sb.from("trattamenti").select("*").eq("user_id",p.id).order("data",{ascending:false}),
          ids.length?sb.from("trappole").select("*").in("oliveto_id",ids):Promise.resolve({data:[]}),
        ]);
        setOliveti(ol||[]);setRils(ri||[]);setSters(st||[]);setTrats(tr||[]);setTraps(tp||[]);
        Cache.set("ol",ol);Cache.set("ri",ri);Cache.set("st",st);Cache.set("tr",tr);Cache.set("tp",tp);
      }
    }catch(e){
      // Offline: load from cache
      if(Cache.get("ol")) setOliveti(Cache.get("ol"));
      if(Cache.get("ri")) setRils(Cache.get("ri"));
      if(Cache.get("st")) setSters(Cache.get("st"));
      if(Cache.get("tr")) setTrats(Cache.get("tr"));
      if(Cache.get("tp")) setTraps(Cache.get("tp"));
      if(Cache.get("cl")) setClients(Cache.get("cl"));
    }
    setDataLoading(false);
  }

  async function logout(){await sb.auth.signOut();Cache.clear();}

  // Still checking session
  if(session===undefined) return(
    <div style={{minHeight:"100vh",background:"linear-gradient(160deg,#052e16,#14532d)",display:"flex",alignItems:"center",justifyContent:"center"}}>
      <div style={{textAlign:"center"}}><div style={{fontSize:60,marginBottom:16}}>ğŸ«’</div><div className="spinner" style={{margin:"0 auto",width:32,height:32,borderWidth:3}}/></div>
    </div>
  );

  const theme=dark?"dark":"light";
  const isAdmin=profile?.role==="admin";
  const headerBg=isAdmin?(dark?"#0f0c29":"#1e1b4b"):(dark?"#0a1f0f":"#052e16");
  const mutedC=dark?"#94a3b8":"#6b7280";
  const activeColor=isAdmin?(dark?"#818cf8":"#3730a3"):(dark?"#4ade80":"#16a34a");

  if(!session||!profile) return <div className={`page ${theme}`}><Login dark={dark}/></div>;

  if(dataLoading) return(
    <div className={`page ${theme}`} style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh"}}>
      <div style={{textAlign:"center"}}><div style={{fontSize:50,marginBottom:12}}>ğŸ«’</div><p style={{color:mutedC}}>Caricamento dati...</p><div className="spinner" style={{margin:"12px auto",width:28,height:28}}/></div>
    </div>
  );

  // Adapt field names for compatibility (Supabase uses oliveto_id, legacy used oId)
  const rilsC=rils.map(r=>({...r,oId:r.oliveto_id||r.oId,cId:r.user_id||r.cId,stagione:r.stagione||new Date(r.data).getFullYear()}));
  const stersC=sters.map(s=>({...s,oId:s.oliveto_id||s.oId,cId:s.user_id||s.cId,stagione:s.stagione||new Date(s.data).getFullYear()}));
  const tratsC=trats.map(t=>({...t,oId:t.oliveto_id||t.oId,cId:t.user_id||t.cId}));
  const trapsC=traps.map(t=>({...t,oId:t.oliveto_id||t.oId}));
  const olivetiC=oliveti.map(o=>({...o,cId:o.user_id||o.cId,var:o.varieta||o.var}));

  const shared={oliveti:olivetiC,rils:rilsC,sters:stersC,trats:tratsC,traps:trapsC,setTraps,dark};
  const user={...profile};

  async function saveOliveto(f){
    const{data}=await sb.from("oliveti").insert({nome:f.nome,loc:f.loc,varieta:f.var||f.varieta,piante:+f.piante||0,ha:+f.ha||0,lat:+f.lat||null,lng:+f.lng||null,user_id:profile.id,admin_id:profile.admin_id||profile.id}).select().single();
    if(data) setOliveti(p=>[...p,data]);
    goHome();
  }
  async function saveRil(f){
    const trap=trapsC.find(t=>t.id===f.trapId);
    const ol=olivetiC.find(o=>o.id===f.oId);
    const{data}=await sb.from("monitoraggi").insert({data:f.data,mosche:f.mosche,meteo:f.meteo,fase:f.fase,oliveto_id:f.oId,trappola_id:f.trapId,trappola:trap?.nome||"",user_id:ol?.user_id||ol?.cId,admin_id:profile.admin_id||profile.id,stagione:new Date(f.data).getFullYear()}).select().single();
    if(data) setRils(p=>[...p,data]);
    goHomeClear();
  }
  async function saveSter(f){
    const ol=olivetiC.find(o=>o.id===f.oId);
    const{data}=await sb.from("campionamenti").insert({data:f.data,camp:+f.camp,uova:+f.uova,l1:+f.l1,l2:+f.l2,l3:+f.l3,pupe:+f.pupe,fori:+f.fori,oliveto_id:f.oId,user_id:ol?.user_id||ol?.cId,admin_id:profile.admin_id||profile.id,stagione:new Date(f.data).getFullYear()}).select().single();
    if(data) setSters(p=>[...p,data]);
    goHomeClear();
  }
  async function saveTrat(f){
    const ol=olivetiC.find(o=>o.id===f.oId);
    const{data}=await sb.from("trattamenti").insert({data:f.data,prodotto:f.prodotto,dose:f.dose,note:f.note,oliveto_id:f.oId,user_id:ol?.user_id||ol?.cId,admin_id:profile.admin_id||profile.id}).select().single();
    if(data) setTrats(p=>[...p,data]);
    goHome();
  }

  function renderPage(){
    if(page==="add-oliveto") return <AddOliveto user={user} onBack={goHome} onSave={saveOliveto} dark={dark}/>;
    if(page==="add-trattamento") return <AddTrattamento oliveto={pdata} user={user} onBack={goHome} onSave={saveTrat} dark={dark}/>;
    if(page==="oliveto-detail") return <OlivetoDetail oliveto={pdata} user={user} onBack={goHome} nav={nav} {...shared}/>;
    if(page==="gestione-trappole") return <GestioneTrappole trappole={trapsC} setTrappole={async(fn)=>{
      const updated=typeof fn==="function"?fn(trapsC):fn;
      setTraps(updated.map(t=>({...t,oliveto_id:t.oId||t.oliveto_id})));
    }} oId={pdata?.oId} oliveto={pdata?.oliveto} dark={dark} onBack={goHome} adminId={profile.id}/>;
    if(isAdmin){
      if(page==="client-detail") return <AdminClientDetail client={pdata} oliveti={olivetiC} rils={rilsC} sters={stersC} traps={trapsC} setTraps={setTraps} onBack={goHome} nav={nav} dark={dark}/>;
      if(page==="admin-oliveto") return <OlivetoDetail oliveto={pdata.oliveto} user={user} onBack={()=>nav("client-detail",pdata.client)} nav={nav} {...shared}/>;
      if(page==="add-rilevamento"||tab==="ril") return <AddRilevamento oliveti={olivetiC} traps={trapsC} onBack={goHomeClear} onSave={saveRil} preClient={pdata?.preClient} dark={dark}/>;
      if(page==="add-stereoscopio"||tab==="ster") return <AddStereoscopio oliveti={olivetiC} onBack={goHomeClear} onSave={saveSter} preClient={pdata?.preClient} dark={dark}/>;
      if(page==="export") return <Export oliveti={olivetiC} rils={rilsC} sters={stersC} onBack={goHome} dark={dark}/>;
      if(tab==="inviti") return <InviteCodes adminId={profile.id} dark={dark} onBack={goHomeClear}/>;
      if(tab==="cal") return(<div style={{padding:"16px 14px 0"}}><h3 style={{margin:"0 0 16px",fontFamily:"Lora,serif",fontSize:18}}>ğŸ“… Calendario interventi</h3><Calendario rils={rilsC} sters={stersC} trats={tratsC} oliveti={olivetiC} dark={dark} role="admin"/></div>);
      if(tab==="soglie") return <Soglie onBack={goHomeClear} dark={dark}/>;
      return <AdminHome oliveti={olivetiC} rils={rilsC} sters={stersC} trats={tratsC} nav={nav} dark={dark} clients={clients}/>;
    }
    if(tab==="cal") return(<div style={{padding:"16px 14px 0"}}><h3 style={{margin:"0 0 16px",fontFamily:"Lora,serif",fontSize:18}}>ğŸ“… Calendario</h3><Calendario rils={rilsC.filter(r=>olivetiC.map(o=>o.id).includes(r.oId))} sters={stersC} trats={tratsC} oliveti={olivetiC} dark={dark} role="client"/></div>);
    return <ClientHome user={user} {...shared} nav={nav}/>;
  }

  const adminTabs=[["home","ğŸ ","Home"],["ril","ğŸª¤","Trappole"],["ster","ğŸ”¬","Stereo"],["cal","ğŸ“…","Calendario"],["inviti","ğŸ”‘","Inviti"]];
  const clientTabs=[["home","ğŸ ","Home"],["oliveti","ğŸ«’","Oliveti"],["cal","ğŸ“…","Calendario"]];
  const tabs=isAdmin?adminTabs:clientTabs;

  return(
    <div className={`page ${theme}`}>
      <div className={`header ${isAdmin?"admin":""}`} style={{background:headerBg,boxShadow:"0 2px 20px rgba(0,0,0,0.3)"}}>
        <div style={{display:"flex",alignItems:"center",gap:8}}>
          <span style={{fontSize:22}}>ğŸ«’</span>
          <span style={{color:"white",fontFamily:"Lora,serif",fontWeight:700,fontSize:18}}>OliveTrack</span>
          {isAdmin&&<span style={{background:"#818cf8",color:"white",padding:"2px 8px",borderRadius:10,fontSize:10,fontWeight:700}}>ADMIN</span>}
          <span title={online?"Online":"Offline â€” dati in cache"} style={{marginLeft:2}}>{online?<span className="dot-online"/>:<span className="dot-offline" title="Offline"/>}</span>
        </div>
        <div style={{display:"flex",gap:8,alignItems:"center"}}>
          <div onClick={toggleDark} style={{width:44,height:24,borderRadius:12,background:dark?"#4ade80":"rgba(255,255,255,0.3)",cursor:"pointer",position:"relative",transition:"background 0.3s",flexShrink:0}}>
            <div style={{position:"absolute",top:2,left:dark?22:2,width:20,height:20,borderRadius:10,background:"white",transition:"left 0.3s",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10}}>{dark?"ğŸŒ™":"â˜€ï¸"}</div>
          </div>
          {isAdmin&&<button onClick={()=>nav("export")} style={{background:"rgba(255,255,255,0.15)",border:"none",color:"white",padding:"5px 10px",borderRadius:16,cursor:"pointer",fontSize:11}}>ğŸ“Š</button>}
          <button onClick={logout} style={{background:"rgba(255,255,255,0.15)",border:"none",color:"white",padding:"5px 12px",borderRadius:16,cursor:"pointer",fontSize:12}}>Esci</button>
        </div>
      </div>
      <div className="scroll-area">{renderPage()}</div>
      {page==="home"&&<div className="bottom-nav nav-bg">
        {tabs.map(([id,icon,lbl])=>(
          <button key={id} className="nav-btn" onClick={()=>{setTab(id);setPage("home");}}>
            <span style={{fontSize:20}}>{icon}</span>
            <span style={{fontSize:10,fontWeight:tab===id?700:500,color:tab===id?activeColor:mutedC}}>{lbl}</span>
          </button>
        ))}
      </div>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>

<!-- PWA Service Worker Registration -->
<script>
if('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    // Inline service worker via blob
    const swCode = `
      const CACHE = 'olivetrack-v1';
      const ASSETS = ['./', './index.html'];
      self.addEventListener('install', e => {
        e.waitUntil(caches.open(CACHE).then(c => c.addAll(ASSETS).catch(()=>{})));
        self.skipWaiting();
      });
      self.addEventListener('activate', e => {
        e.waitUntil(caches.keys().then(keys =>
          Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))
        ));
        self.clients.claim();
      });
      self.addEventListener('fetch', e => {
        e.respondWith(
          fetch(e.request).catch(() => caches.match(e.request))
        );
      });
    `;
    const blob = new Blob([swCode], {type:'application/javascript'});
    const url = URL.createObjectURL(blob);
    navigator.serviceWorker.register(url).catch(()=>{});
  });
}

// PWA Install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  // Show install banner after 3 seconds if not already installed
  setTimeout(() => {
    if(deferredPrompt && document.getElementById('install-banner')) {
      document.getElementById('install-banner').style.display = 'flex';
    }
  }, 3000);
});
window.addEventListener('appinstalled', () => {
  const b = document.getElementById('install-banner');
  if(b) b.style.display = 'none';
  deferredPrompt = null;
});
</script>

<!-- Install banner (Android Chrome) -->
<div id="install-banner" style="display:none;position:fixed;bottom:90px;left:50%;transform:translateX(-50%);width:calc(100% - 32px);max-width:398px;background:#052e16;color:white;border-radius:16px;padding:14px 18px;align-items:center;gap:12px;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,0.4);">
  <span style="font-size:28px">ğŸ«’</span>
  <div style="flex:1">
    <div style="font-weight:700;font-size:14px">Installa OliveTrack</div>
    <div style="font-size:12px;opacity:0.8">Aggiungila alla schermata home</div>
  </div>
  <button onclick="deferredPrompt&&deferredPrompt.prompt();document.getElementById('install-banner').style.display='none';"
    style="background:#16a34a;color:white;border:none;border-radius:10px;padding:8px 16px;font-weight:700;cursor:pointer;font-size:13px">
    Installa
  </button>
  <button onclick="document.getElementById('install-banner').style.display='none';"
    style="background:rgba(255,255,255,0.15);color:white;border:none;border-radius:10px;padding:8px 10px;cursor:pointer;font-size:16px">Ã—</button>
</div>
</body></html>
